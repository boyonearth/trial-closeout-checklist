<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trial Close-Out Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app"></div>
    <script>
        const STORAGE_KEY = 'trial_closeout_checklist_v7';
        const initialData = {
            version: "7.0",
            studyId: "STUDY-ABCD-001",
            studyName: "Enter Your Study Name",
            protocolName: "PROTO-1234-001",
            trialType: "Interventional",
            lpfvDateForecasted: "2024-02-15",
            lpfvDateActual: "2024-02-15",
            targetDbLockForecasted: "2024-04-30",
            targetDbLockActual: "",
            finalReportForecasted: "2024-08-15",
            finalReportActual: "",
            closeoutTasks: [
                { id: 1, name: "Last Patient Final Visit", description: "Completed on schedule", category: "Data Management", owner: "Sarah Chen", role: "CRA", deadline: "2024-02-15", status: "Completed", priority: "Critical", progress: 100, dependencies: [] },
                { id: 2, name: "Query Resolution", description: "23 queries remaining", category: "Data Management", owner: "Mike Rodriguez", role: "Data Manager", deadline: "2024-03-30", status: "In Progress", priority: "Critical", progress: 85, dependencies: [1] },
            ],
            categories: ["Data Management", "Safety", "Quality", "Biostatistics", "Regulatory", "Documentation"],
            complianceMetrics: { protocolDeviations: 12, outstandingQueries: 88, saesPending: 2, etmfCompleteness: 87, inspectionReadiness: 75 },
            documents: []
        };

        let studyData = loadData();
        let lastSaved = new Date();

        function loadData() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    if (!data.documents) data.documents = [];
                    return data;
                }
            } catch (e) { console.error('Load error:', e); }
            return initialData;
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(studyData));
                lastSaved = new Date();
                updateSaveStatus();
            } catch (e) { console.error('Save error:', e); }
        }

        function updateSaveStatus() {
            const diff = Math.floor((new Date() - lastSaved) / 1000);
            let text = diff < 10 ? 'just now' : diff < 60 ? diff + 's ago' : diff < 3600 ? Math.floor(diff / 60) + 'm ago' : lastSaved.toLocaleTimeString();
            const el = document.getElementById('save-status');
            if (el) el.textContent = 'Auto-saved ' + text;
        }

        function calculateDays(dateStr) {
            if (!dateStr) return null;
            return Math.floor((new Date() - new Date(dateStr)) / 86400000);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function exportToExcel() {
            const ws_data = [['Trial Close-Out Checklist v' + studyData.version], ['Study: ' + studyData.studyName], ['Study ID: ' + studyData.studyId], ['Protocol: ' + studyData.protocolName], [], ['Task', 'Description', 'Category', 'Owner', 'Role', 'Priority', 'Deadline', 'Status', 'Progress', 'Dependencies']];
            studyData.closeoutTasks.forEach(task => {
                const deps = task.dependencies.map(id => studyData.closeoutTasks.find(x => x.id === id)?.name || id).join('; ');
                ws_data.push([task.name, task.description || '', task.category, task.owner, task.role, task.priority, task.deadline, task.status, task.progress + '%', deps]);
            });
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Tasks");
            XLSX.writeFile(wb, studyData.studyId + '_checklist_' + new Date().toISOString().split('T')[0] + '.xlsx');
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16); doc.text('Trial Close-Out Checklist v' + studyData.version, 20, 20);
            doc.setFontSize(10); doc.text('Study: ' + studyData.studyName, 20, 30);
            doc.text('Study ID: ' + studyData.studyId + ' | Protocol: ' + studyData.protocolName, 20, 35);
            let y = 45; doc.setFontSize(12); doc.text('Tasks:', 20, y); y += 7; doc.setFontSize(9);
            studyData.closeoutTasks.forEach(task => {
                if (y > 270) { doc.addPage(); y = 20; }
                doc.text(task.name + ' - ' + task.status + ' (' + task.progress + '%) - ' + task.priority, 20, y);
                y += 6;
            });
            doc.save(studyData.studyId + '_checklist.pdf');
        }

        function exportToWord() {
            let html = '<html><head><meta charset="utf-8"></head><body style="font-family: Arial;">';
            html += '<h1>Trial Close-Out Checklist v' + studyData.version + '</h1>';
            html += '<p><b>Study:</b> ' + studyData.studyName + '<br><b>Study ID:</b> ' + studyData.studyId + '<br><b>Protocol:</b> ' + studyData.protocolName + '</p>';
            html += '<h2>Tasks</h2><table border="1" cellpadding="8" style="border-collapse: collapse; width: 100%;">';
            html += '<tr><th>Task</th><th>Category</th><th>Owner</th><th>Priority</th><th>Deadline</th><th>Status</th><th>Progress</th><th>Description</th></tr>';
            studyData.closeoutTasks.forEach(task => {
                html += '<tr><td>' + task.name + '</td><td>' + task.category + '</td><td>' + task.owner + '</td><td>' + task.priority + '</td><td>' + task.deadline + '</td><td>' + task.status + '</td><td>' + task.progress + '%</td><td>' + (task.description || '') + '</td></tr>';
            });
            html += '</table></body></html>';
            const blob = new Blob([html], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url; link.download = studyData.studyId + '_checklist.doc'; link.click();
            URL.revokeObjectURL(url);
        }

        function exportJSON() {
            const blob = new Blob([JSON.stringify(studyData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url; link.download = studyData.studyId + '_v' + studyData.version + '_backup.json'; link.click();
            URL.revokeObjectURL(url);
        }

        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (imported.studyId && imported.closeoutTasks) {
                            studyData = imported;
                            if (!studyData.documents) studyData.documents = [];
                            saveData(); render();
                            alert('Data restored successfully!');
                        } else { alert('Invalid file format'); }
                    } catch (err) { alert('Error reading file'); }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function showModal(type) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto p-4';
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
            let content = '';

            if (type === 'help') {
                content = `
                    <div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-screen overflow-y-auto">
                        <h3 class="text-2xl font-bold mb-6 text-gray-800">üìñ User Guide</h3>
                        <div class="space-y-6">
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                                <h4 class="font-bold text-blue-900 mb-2">‚ö†Ô∏è CRITICAL: Backup Your Data!</h4>
                                <p class="text-sm text-blue-800">Your data is stored ONLY on your computer's browser. Create weekly backups using the "Backup" button to prevent data loss!</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg mb-2">‚úÖ What This Dashboard Does</h4>
                                <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                                    <li>Track all trial close-out tasks with deadlines and priorities</li>
                                    <li>Monitor progress by regulatory category</li>
                                    <li>Manage compliance metrics (queries, eTMF, inspection readiness)</li>
                                    <li>Track key milestone dates (LPFV, DB Lock, Final Report)</li>
                                    <li>Store and organize trial documents with file attachments</li>
                                    <li>Auto-save all changes to your browser</li>
                                    <li>Export reports in Excel, PDF, or Word format</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg mb-2">‚ùå What This Dashboard Does NOT Do</h4>
                                <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                                    <li><strong>NO team collaboration</strong> - Each user has separate data</li>
                                    <li><strong>NO cloud storage</strong> - Data only on your computer</li>
                                    <li><strong>NO email alerts</strong> - You must track deadlines manually</li>
                                    <li><strong>NO multi-device sync</strong> - Use same browser/computer</li>
                                    <li><strong>NO automatic backups</strong> - You must backup manually</li>
                                    <li><strong>NO system integration</strong> - Does not connect to CTMS/EDC/eTMF</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg mb-2">üöÄ Quick Start</h4>
                                <div class="bg-gray-50 p-4 rounded text-sm space-y-2">
                                    <p><strong>1. Settings:</strong> Click "‚öôÔ∏è Settings" ‚Üí Enter study info ‚Üí Save</p>
                                    <p><strong>2. Add Tasks:</strong> Click "+ Add Task" ‚Üí Fill details ‚Üí Save</p>
                                    <p><strong>3. Backup:</strong> Click "üíæ Backup" ‚Üí Download ‚Üí Save to safe location</p>
                                    <p><strong>4. Bookmark:</strong> Press Ctrl+D to bookmark this page</p>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg mb-2">üíæ How to Backup (CRITICAL)</h4>
                                <div class="bg-red-50 border-l-4 border-red-500 p-4 text-sm space-y-2">
                                    <p class="font-bold text-red-900">You WILL Lose Data If:</p>
                                    <ul class="list-disc list-inside text-red-800">
                                        <li>Browser data is cleared</li>
                                        <li>You switch browsers or computers</li>
                                        <li>Computer crashes</li>
                                    </ul>
                                    <p class="font-bold text-red-900 mt-3">Weekly Backup Steps:</p>
                                    <ol class="list-decimal list-inside text-red-800">
                                        <li>Click "üíæ Backup" button</li>
                                        <li>Click "Download Backup"</li>
                                        <li>Save to network drive or cloud (OneDrive, Google Drive)</li>
                                        <li>Name it: STUDY-ID_backup_2025-01-26.json</li>
                                    </ol>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg mb-2">üìä Metrics Explained</h4>
                                <div class="text-sm space-y-2">
                                    <p><strong>Automatic Updates:</strong></p>
                                    <ul class="list-disc list-inside text-gray-700 ml-4">
                                        <li>Overall Progress: (Completed √∑ Total) √ó 100</li>
                                        <li>Days Since LPFV: Today - LPFV Date</li>
                                        <li>Days to DB Lock: DB Lock Date - Today</li>
                                        <li>Progress by Category: Completion % per category</li>
                                    </ul>
                                    <p class="mt-2"><strong>Manual Updates (in Settings):</strong></p>
                                    <ul class="list-disc list-inside text-gray-700 ml-4">
                                        <li>Outstanding Queries: From your EDC system</li>
                                        <li>eTMF Completeness: From your eTMF platform</li>
                                        <li>Inspection Readiness: Your assessment</li>
                                    </ul>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg mb-2">‚úÖ Best Practices</h4>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <p class="font-medium text-green-700 mb-1">DO:</p>
                                        <ul class="list-disc list-inside text-gray-700">
                                            <li>Bookmark this page</li>
                                            <li>Use same browser always</li>
                                            <li>Create weekly backups</li>
                                            <li>Save backups to cloud/network</li>
                                            <li>Add task descriptions</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <p class="font-medium text-red-700 mb-1">DON'T:</p>
                                        <ul class="list-disc list-inside text-gray-700">
                                            <li>Switch browsers</li>
                                            <li>Use incognito mode</li>
                                            <li>Clear browser data</li>
                                            <li>Assume data is in cloud</li>
                                            <li>Forget to backup!</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg mb-2">üîß Troubleshooting</h4>
                                <div class="text-sm space-y-2">
                                    <p><strong>Data disappeared?</strong> ‚Üí Restore from JSON backup</p>
                                    <p><strong>Changes not saving?</strong> ‚Üí Check "Auto-saved" message, don't use incognito</p>
                                    <p><strong>Updates not showing?</strong> ‚Üí Press Ctrl+Shift+R to hard refresh</p>
                                </div>
                            </div>
                            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">
                                <h4 class="font-bold text-yellow-900 mb-2">üîí Your Data is Private</h4>
                                <p class="text-sm text-yellow-800">All your trial data is stored ONLY on your computer's browser. No one else can see it. Keep your backups secure!</p>
                            </div>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="mt-6 w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Close Help</button>
                    </div>
                `;
            } else if (type === 'export') {
                content = '<div class="bg-white rounded-lg p-6 max-w-lg w-full"><h3 class="text-xl font-bold mb-4">Export Checklist</h3><div class="space-y-3"><button onclick="exportToExcel()" class="w-full px-4 py-3 bg-green-50 hover:bg-green-100 border border-green-200 rounded-md text-left"><div class="font-medium">üìä Export to Excel</div><div class="text-xs text-gray-500">Download as .xlsx spreadsheet</div></button><button onclick="exportToPDF()" class="w-full px-4 py-3 bg-red-50 hover:bg-red-100 border border-red-200 rounded-md text-left"><div class="font-medium">üìÑ Export to PDF</div><div class="text-xs text-gray-500">Download as PDF document</div></button><button onclick="exportToWord()" class="w-full px-4 py-3 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-md text-left"><div class="font-medium">üìù Export to Word</div><div class="text-xs text-gray-500">Download as .doc file</div></button></div><button onclick="this.closest(\'.fixed\').remove()" class="mt-4 w-full px-4 py-2 border rounded-md">Close</button></div>';
            } else if (type === 'backup') {
                content = '<div class="bg-white rounded-lg p-6 max-w-lg w-full"><h3 class="text-xl font-bold mb-4">Backup & Restore</h3><div class="space-y-3"><button onclick="exportJSON()" class="w-full px-4 py-3 bg-blue-50 hover:bg-blue-100 border rounded-md text-left"><div class="font-medium">üíæ Download Backup</div><div class="text-xs text-gray-500">Export as JSON</div></button><button onclick="importJSON()" class="w-full px-4 py-3 bg-purple-50 hover:bg-purple-100 border rounded-md text-left"><div class="font-medium">üìÇ Restore Backup</div><div class="text-xs text-gray-500">Import JSON file</div></button></div><button onclick="this.closest(\'.fixed\').remove()" class="mt-4 w-full px-4 py-2 border rounded-md">Close</button></div>';
            } else if (type === 'documents') {
                content = '<div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-screen overflow-y-auto"><h3 class="text-xl font-bold mb-4">Documents</h3><div class="mb-4"><button onclick="addDocument()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md">+ Add Document</button></div><div class="space-y-2">' + ((studyData.documents || []).length === 0 ? '<p class="text-gray-500 text-center py-8">No documents yet</p>' : studyData.documents.map((doc, idx) => '<div class="border rounded-lg p-4 hover:bg-gray-50"><div class="flex justify-between"><div class="flex-1"><h4 class="font-medium text-gray-800">' + doc.name + '</h4>' + (doc.description ? '<p class="text-sm text-gray-600 mt-1">' + doc.description + '</p>' : '') + '<div class="flex gap-4 mt-2 text-xs text-gray-500"><span>Type: ' + doc.type + '</span><span>Category: ' + doc.category + '</span><span>Version: ' + doc.version + '</span>' + (doc.fileSize ? '<span>Size: ' + doc.fileSize + '</span>' : '') + (doc.uploadDate ? '<span>Uploaded: ' + doc.uploadDate + '</span>' : '') + '</div></div><div class="flex gap-2">' + (doc.fileData ? '<button onclick="downloadDocument(' + idx + ')" class="text-blue-600 hover:text-blue-800">‚¨áÔ∏è</button>' : '') + '<button onclick="editDocument(' + idx + ')" class="text-green-600 hover:text-green-800">‚úèÔ∏è</button><button onclick="deleteDocument(' + idx + ')" class="text-red-600 hover:text-red-800">üóëÔ∏è</button></div></div></div>').join('')) + '</div><button onclick="this.closest(\'.fixed\').remove()" class="mt-4 w-full px-4 py-2 border rounded-md">Close</button></div>';
            } else if (type === 'document-form') {
                const isEdit = window.editingDocIndex !== undefined;
                const doc = isEdit ? studyData.documents[window.editingDocIndex] : { name: '', description: '', type: 'Protocol', category: studyData.categories[0], version: '1.0' };
                content = '<div class="bg-white rounded-lg p-6 max-w-2xl w-full"><h3 class="text-xl font-bold mb-4">' + (isEdit ? 'Edit' : 'Add') + ' Document</h3><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Document Name *</label><input type="text" id="docName" value="' + doc.name + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Description</label><textarea id="docDescription" class="w-full px-3 py-2 border rounded-md" rows="3">' + (doc.description || '') + '</textarea></div><div class="grid grid-cols-3 gap-4"><div><label class="block text-sm font-medium mb-1">Type</label><select id="docType" class="w-full px-3 py-2 border rounded-md">' + ['Protocol', 'ICF', 'CSR', 'SAP', 'Report', 'Other'].map(t => '<option ' + (t === doc.type ? 'selected' : '') + '>' + t + '</option>').join('') + '</select></div><div><label class="block text-sm font-medium mb-1">Category</label><select id="docCategory" class="w-full px-3 py-2 border rounded-md">' + studyData.categories.map(c => '<option ' + (c === doc.category ? 'selected' : '') + '>' + c + '</option>').join('') + '</select></div><div><label class="block text-sm font-medium mb-1">Version</label><input type="text" id="docVersion" value="' + doc.version + '" class="w-full px-3 py-2 border rounded-md"></div></div><div class="border-t pt-4"><label class="block text-sm font-medium mb-2">üìé Attach File (Optional)</label><input type="file" id="docFileInput" class="w-full px-3 py-2 border rounded-md text-sm">' + (doc.fileName ? '<p class="text-xs text-green-600 mt-2">‚úì Current: ' + doc.fileName + ' (' + doc.fileSize + ')</p>' : '') + '<p class="text-xs text-gray-500 mt-1">Upload PDF, Word, Excel, or other files</p></div></div><div class="flex justify-end gap-3 mt-6"><button onclick="this.closest(\'.fixed\').remove(); window.editingDocIndex = undefined;" class="px-4 py-2 border rounded-md">Cancel</button><button onclick="saveDocument()" class="px-4 py-2 bg-green-600 text-white rounded-md">Save</button></div></div>';
            } else if (type === 'categories') {
                content = '<div class="bg-white rounded-lg p-6 max-w-2xl w-full"><h3 class="text-xl font-bold mb-4">Manage Categories</h3><div class="space-y-2 mb-4" id="categoryList">' + studyData.categories.map((cat, idx) => '<div class="flex gap-2"><input type="text" value="' + cat + '" class="flex-1 px-3 py-2 border rounded-md" id="cat_' + idx + '"><button onclick="removeCategory(' + idx + ')" class="px-3 py-2 bg-red-100 hover:bg-red-200 text-red-600 rounded-md">Remove</button></div>').join('') + '</div><button onclick="addCategory()" class="w-full px-4 py-2 bg-green-100 hover:bg-green-200 text-green-700 rounded-md mb-4">+ Add</button><div class="flex justify-end gap-3"><button onclick="this.closest(\'.fixed\').remove()" class="px-4 py-2 border rounded-md">Cancel</button><button onclick="saveCategories()" class="px-4 py-2 bg-blue-600 text-white rounded-md">Save</button></div></div>';
            } else if (type === 'settings') {
                content = '<div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-screen overflow-y-auto"><h3 class="text-xl font-bold mb-4">Study Settings</h3><div class="space-y-4"><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Version</label><input type="text" id="version" value="' + studyData.version + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Study ID</label><input type="text" id="studyId" value="' + studyData.studyId + '" class="w-full px-3 py-2 border rounded-md"></div></div><div><label class="block text-sm font-medium mb-1">Study Name</label><input type="text" id="studyName" value="' + studyData.studyName + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Protocol Name</label><input type="text" id="protocolName" value="' + studyData.protocolName + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Trial Type</label><input type="text" id="trialType" value="' + studyData.trialType + '" class="w-full px-3 py-2 border rounded-md"></div><div class="border-t pt-4"><h4 class="font-semibold mb-3">Compliance Metrics</h4><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Outstanding Queries</label><input type="number" id="outstandingQueries" value="' + studyData.complianceMetrics.outstandingQueries + '" class="w-full px-3 py-2 border rounded-md" min="0"></div><div><label class="block text-sm font-medium mb-1">eTMF Completeness (%)</label><input type="number" id="etmfCompleteness" value="' + studyData.complianceMetrics.etmfCompleteness + '" class="w-full px-3 py-2 border rounded-md" min="0" max="100"></div><div><label class="block text-sm font-medium mb-1">Inspection Readiness (%)</label><input type="number" id="inspectionReadiness" value="' + studyData.complianceMetrics.inspectionReadiness + '" class="w-full px-3 py-2 border rounded-md" min="0" max="100"></div></div></div><div class="border-t pt-4"><h4 class="font-semibold mb-3">LPFV Date</h4><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Forecasted</label><input type="date" id="lpfvDateForecasted" value="' + studyData.lpfvDateForecasted + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Actual</label><input type="date" id="lpfvDateActual" value="' + (studyData.lpfvDateActual || '') + '" class="w-full px-3 py-2 border rounded-md"></div></div></div><div class="border-t pt-4"><h4 class="font-semibold mb-3">Database Lock Date</h4><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Forecasted</label><input type="date" id="targetDbLockForecasted" value="' + studyData.targetDbLockForecasted + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Actual</label><input type="date" id="targetDbLockActual" value="' + (studyData.targetDbLockActual || '') + '" class="w-full px-3 py-2 border rounded-md"></div></div></div><div class="border-t pt-4"><h4 class="font-semibold mb-3">Final Report Date</h4><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Forecasted</label><input type="date" id="finalReportForecasted" value="' + (studyData.finalReportForecasted || '') + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Actual</label><input type="date" id="finalReportActual" value="' + (studyData.finalReportActual || '') + '" class="w-full px-3 py-2 border rounded-md"></div></div></div></div><div class="flex justify-end gap-3 mt-6"><button onclick="this.closest(\'.fixed\').remove()" class="px-4 py-2 border rounded-md">Cancel</button><button onclick="saveSettings()" class="px-4 py-2 bg-blue-600 text-white rounded-md">Save</button></div></div>';
            } else if (type === 'task') {
                const isEdit = window.editingTask;
                const task = isEdit || { name: '', description: '', category: studyData.categories[0], owner: '', role: '', deadline: '', status: 'Not Started', priority: 'Medium', progress: 0, dependencies: [] };
                content = '<div class="bg-white rounded-lg p-6 max-w-3xl w-full max-h-screen overflow-y-auto"><h3 class="text-xl font-bold mb-4">' + (isEdit ? 'Edit' : 'Add') + ' Task</h3><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Task Name *</label><input type="text" id="taskName" value="' + task.name + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Description / Comments</label><textarea id="taskDescription" class="w-full px-3 py-2 border rounded-md" rows="3" placeholder="Add notes...">' + (task.description || '') + '</textarea></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Category</label><select id="taskCategory" class="w-full px-3 py-2 border rounded-md">' + studyData.categories.map(c => '<option ' + (c === task.category ? 'selected' : '') + '>' + c + '</option>').join('') + '</select></div><div><label class="block text-sm font-medium mb-1">Priority</label><select id="taskPriority" class="w-full px-3 py-2 border rounded-md">' + ['Critical', 'High', 'Medium', 'Low'].map(p => '<option ' + (p === task.priority ? 'selected' : '') + '>' + p + '</option>').join('') + '</select></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Role *</label><input type="text" id="taskRole" value="' + task.role + '" class="w-full px-3 py-2 border rounded-md" placeholder="e.g., Data Manager"></div><div><label class="block text-sm font-medium mb-1">Owner *</label><input type="text" id="taskOwner" value="' + task.owner + '" class="w-full px-3 py-2 border rounded-md" placeholder="Person name"></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Deadline *</label><input type="date" id="taskDeadline" value="' + task.deadline + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Status</label><select id="taskStatus" class="w-full px-3 py-2 border rounded-md">' + ['Not Started', 'In Progress', 'Completed'].map(s => '<option ' + (s === task.status ? 'selected' : '') + '>' + s + '</option>').join('') + '</select></div></div><div><label class="block text-sm font-medium mb-1">Progress (%)</label><input type="number" id="taskProgress" value="' + task.progress + '" min="0" max="100" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Dependencies</label><select id="taskDependencies" multiple class="w-full px-3 py-2 border rounded-md" style="height: 100px">' + studyData.closeoutTasks.filter(t => !isEdit || t.id !== task.id).map(t => '<option value="' + t.id + '" ' + (task.dependencies && task.dependencies.includes(t.id) ? 'selected' : '') + '>' + t.name + '</option>').join('') + '</select><p class="text-xs text-gray-500">Hold Ctrl/Cmd to select multiple</p></div></div><div class="flex justify-end gap-3 mt-6"><button onclick="this.closest(\'.fixed\').remove(); window.editingTask = null;" class="px-4 py-2 border rounded-md">Cancel</button><button onclick="saveTask()" class="px-4 py-2 bg-green-600 text-white rounded-md">Save</button></div></div>';
            }

            overlay.innerHTML = content;
            document.body.appendChild(overlay);
        }

        function addDocument() { window.editingDocIndex = undefined; showModal('document-form'); }
        function editDocument(idx) { window.editingDocIndex = idx; showModal('document-form'); }
        function deleteDocument(idx) { if (confirm('Delete?')) { studyData.documents.splice(idx, 1); saveData(); document.querySelector('.fixed').remove(); showModal('documents'); } }
        
        function saveDocument() {
            const name = document.getElementById('docName').value;
            if (!name) { alert('Name required'); return; }
            const fileInput = document.getElementById('docFileInput');
            const doc = studyData.documents && window.editingDocIndex !== undefined ? {...studyData.documents[window.editingDocIndex]} : {};
            doc.name = name; doc.description = document.getElementById('docDescription').value;
            doc.type = document.getElementById('docType').value; doc.category = document.getElementById('docCategory').value;
            doc.version = document.getElementById('docVersion').value;
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    doc.fileName = file.name; doc.fileSize = (file.size / 1024).toFixed(2) + ' KB';
                    doc.uploadDate = new Date().toISOString().split('T')[0]; doc.fileData = e.target.result;
                    if (!studyData.documents) studyData.documents = [];
                    if (window.editingDocIndex !== undefined) studyData.documents[window.editingDocIndex] = doc;
                    else studyData.documents.push(doc);
                    saveData(); window.editingDocIndex = undefined;
                    document.querySelector('.fixed').remove(); showModal('documents');
                };
                reader.readAsDataURL(file);
            } else {
                if (!studyData.documents) studyData.documents = [];
                if (window.editingDocIndex !== undefined) studyData.documents[window.editingDocIndex] = doc;
                else studyData.documents.push(doc);
                saveData(); window.editingDocIndex = undefined;
                document.querySelector('.fixed').remove(); showModal('documents');
            }
        }

        function downloadDocument(idx) {
            const doc = studyData.documents[idx];
            if (!doc.fileData) { alert('No file attached'); return; }
            const link = document.createElement('a');
            link.href = doc.fileData; link.download = doc.fileName; link.click();
        }

        function addCategory() {
            const list = document.getElementById('categoryList');
            const div = document.createElement('div'); div.className = 'flex gap-2';
            div.innerHTML = '<input type="text" value="" class="flex-1 px-3 py-2 border rounded-md" id="cat_' + studyData.categories.length + '" placeholder="New Category"><button onclick="this.parentElement.remove()" class="px-3 py-2 bg-red-100 text-red-600 rounded-md">Remove</button>';
            list.appendChild(div);
        }

        function removeCategory(idx) {
            const cat = studyData.categories[idx];
            if (studyData.closeoutTasks.some(t => t.category === cat)) { alert('Category in use'); return; }
            document.getElementById('cat_' + idx).parentElement.remove();
        }

        function saveCategories() {
            const newCats = Array.from(document.querySelectorAll('[id^="cat_"]')).map(inp => inp.value.trim()).filter(v => v);
            if (newCats.length === 0) { alert('Need at least 1 category'); return; }
            studyData.categories = newCats; saveData(); render(); document.querySelector('.fixed').remove();
        }

        function saveSettings() {
            studyData.version = document.getElementById('version').value;
            studyData.studyId = document.getElementById('studyId').value;
            studyData.studyName = document.getElementById('studyName').value;
            studyData.protocolName = document.getElementById('protocolName').value;
            studyData.trialType = document.getElementById('trialType').value;
            studyData.lpfvDateForecasted = document.getElementById('lpfvDateForecasted').value;
            studyData.lpfvDateActual = document.getElementById('lpfvDateActual').value;
            studyData.targetDbLockForecasted = document.getElementById('targetDbLockForecasted').value;
            studyData.targetDbLockActual = document.getElementById('targetDbLockActual').value;
            studyData.finalReportForecasted = document.getElementById('finalReportForecasted').value;
            studyData.finalReportActual = document.getElementById('finalReportActual').value;
            studyData.complianceMetrics.outstandingQueries = parseInt(document.getElementById('outstandingQueries').value) || 0;
            studyData.complianceMetrics.etmfCompleteness = parseInt(document.getElementById('etmfCompleteness').value) || 0;
            studyData.complianceMetrics.inspectionReadiness = parseInt(document.getElementById('inspectionReadiness').value) || 0;
            saveData(); render(); document.querySelector('.fixed').remove();
        }

        function saveTask() {
            const name = document.getElementById('taskName').value;
            const role = document.getElementById('taskRole').value;
            const owner = document.getElementById('taskOwner').value;
            const deadline = document.getElementById('taskDeadline').value;
            if (!name || !role || !owner || !deadline) { alert('Fill required fields'); return; }
            const dependencies = Array.from(document.getElementById('taskDependencies').selectedOptions).map(opt => parseInt(opt.value));
            const task = {
                id: window.editingTask ? window.editingTask.id : Math.max(0, ...studyData.closeoutTasks.map(t => t.id)) + 1,
                name, description: document.getElementById('taskDescription').value,
                category: document.getElementById('taskCategory').value, priority: document.getElementById('taskPriority').value,
                role, owner, deadline, status: document.getElementById('taskStatus').value,
                progress: parseInt(document.getElementById('taskProgress').value), dependencies
            };
            if (window.editingTask) {
                const idx = studyData.closeoutTasks.findIndex(t => t.id === window.editingTask.id);
                studyData.closeoutTasks[idx] = task;
            } else studyData.closeoutTasks.push(task);
            saveData(); render(); document.querySelector('.fixed').remove(); window.editingTask = null;
        }

        function editTask(id) { window.editingTask = studyData.closeoutTasks.find(t => t.id === id); showModal('task'); }
        
        function deleteTask(id) {
            if (confirm('Delete?')) {
                studyData.closeoutTasks = studyData.closeoutTasks.filter(t => t.id !== id);
                studyData.closeoutTasks.forEach(t => { t.dependencies = t.dependencies.filter(dep => dep !== id); });
                saveData(); render();
            }
        }

        function getCategoryProgress() {
            return studyData.categories.map(cat => {
                const tasks = studyData.closeoutTasks.filter(t => t.category === cat);
                const completed = tasks.filter(t => t.status === 'Completed').length;
                return { name: cat, completed, total: tasks.length, percentage: tasks.length > 0 ? Math.round((completed / tasks.length) * 100) : 0 };
            });
        }

        function sortTasks(tasks, sortBy) {
            const sorted = [...tasks];
            if (sortBy === 'name') sorted.sort((a, b) => a.name.localeCompare(b.name));
            else if (sortBy === 'deadline') sorted.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
            else if (sortBy === 'priority') { const prio = { 'Critical': 1, 'High': 2, 'Medium': 3, 'Low': 4 }; sorted.sort((a, b) => prio[a.priority] - prio[b.priority]); }
            else if (sortBy === 'status') { const stat = { 'Not Started': 1, 'In Progress': 2, 'Completed': 3 }; sorted.sort((a, b) => stat[a.status] - stat[b.status]); }
            else if (sortBy === 'progress') sorted.sort((a, b) => b.progress - a.progress);
            return sorted;
        }

        function render() {
            const lpfvF = calculateDays(studyData.lpfvDateForecasted);
            const lpfvA = calculateDays(studyData.lpfvDateActual);
            const dblF = studyData.targetDbLockForecasted ? -calculateDays(studyData.targetDbLockForecasted) : null;
            const dblA = studyData.targetDbLockActual ? -calculateDays(studyData.targetDbLockActual) : null;
            const frF = studyData.finalReportForecasted ? -calculateDays(studyData.finalReportForecasted) : null;
            const frA = studyData.finalReportActual ? -calculateDays(studyData.finalReportActual) : null;
            const completed = studyData.closeoutTasks.filter(t => t.status === 'Completed').length;
            const progress = studyData.closeoutTasks.length > 0 ? Math.round((completed / studyData.closeoutTasks.length) * 100) : 0;
            const filter = window.currentFilter || { category: '', priority: '', status: '' };
            const sort = window.currentSort || 'deadline';
            let filtered = studyData.closeoutTasks.filter(t => (!filter.category || t.category === filter.category) && (!filter.priority || t.priority === filter.priority) && (!filter.status || t.status === filter.status));
            filtered = sortTasks(filtered, sort);
            const categoryProgress = getCategoryProgress();

            document.getElementById('app').innerHTML = '<div class="min-h-screen p-6"><div class="bg-white rounded-lg shadow border p-6 mb-6"><div class="flex justify-between items-start flex-wrap gap-4"><div><div class="flex items-center gap-3"><h1 class="text-3xl font-bold text-gray-800">' + studyData.studyName + '</h1></div><p class="text-gray-600 mt-1">ID: ' + studyData.studyId + ' | Protocol: ' + studyData.protocolName + ' | Type: ' + studyData.trialType + '</p><div class="flex items-center gap-3 mt-2"><p class="text-sm text-gray-500">Trial Close-Out Checklist</p><span id="save-status" class="text-xs text-green-600"></span></div></div><div class="flex gap-2 flex-wrap"><button onclick="showModal(\'help\')" class="px-4 py-2 bg-cyan-100 hover:bg-cyan-200 rounded-md text-sm">‚ùì Help</button><button onclick="showModal(\'export\')" class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 rounded-md text-sm">üì§ Export</button><button onclick="showModal(\'backup\')" class="px-4 py-2 bg-purple-100 hover:bg-purple-200 rounded-md text-sm">üíæ Backup</button><button onclick="showModal(\'documents\')" class="px-4 py-2 bg-orange-100 hover:bg-orange-200 rounded-md text-sm">üìÑ Documents</button><button onclick="showModal(\'categories\')" class="px-4 py-2 bg-yellow-100 hover:bg-yellow-200 rounded-md text-sm">üìÅ Categories</button><button onclick="showModal(\'settings\')" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-md text-sm">‚öôÔ∏è Settings</button><button onclick="showModal(\'task\')" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm">+ Add Task</button></div></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"><div class="bg-white rounded-lg shadow border p-4"><h3 class="text-xs font-medium text-gray-600 mb-2">Days Since LPFV</h3><div class="grid grid-cols-2 gap-2"><div><div class="text-sm text-gray-500">Forecast</div><div class="text-xl font-bold text-gray-800">' + (lpfvF !== null ? Math.abs(lpfvF) : 'N/A') + '</div><div class="text-xs text-gray-500">(' + formatDate(studyData.lpfvDateForecasted) + ')</div></div><div><div class="text-sm text-gray-500">Actual</div><div class="text-xl font-bold text-blue-600">' + (lpfvA !== null ? Math.abs(lpfvA) : 'N/A') + '</div><div class="text-xs text-gray-500">(' + formatDate(studyData.lpfvDateActual) + ')</div></div></div></div><div class="bg-white rounded-lg shadow border p-4"><h3 class="text-xs font-medium text-gray-600 mb-2">Days to DB Lock</h3><div class="grid grid-cols-2 gap-2"><div><div class="text-sm text-gray-500">Forecast</div><div class="text-xl font-bold ' + (dblF !== null && dblF < 30 ? 'text-red-600' : 'text-gray-800') + '">' + (dblF !== null ? dblF : 'N/A') + '</div><div class="text-xs text-gray-500">(' + formatDate(studyData.targetDbLockForecasted) + ')</div></div><div><div class="text-sm text-gray-500">Actual</div><div class="text-xl font-bold ' + (dblA !== null && dblA < 30 ? 'text-red-600' : 'text-blue-600') + '">' + (dblA !== null ? dblA : 'N/A') + '</div><div class="text-xs text-gray-500">(' + formatDate(studyData.targetDbLockActual) + ')</div></div></div></div><div class="bg-white rounded-lg shadow border p-4"><h3 class="text-xs font-medium text-gray-600 mb-2">Days to Final Report</h3><div class="grid grid-cols-2 gap-2"><div><div class="text-sm text-gray-500">Forecast</div><div class="text-xl font-bold text-gray-800">' + (frF !== null ? frF : 'N/A') + '</div><div class="text-xs text-gray-500">(' + formatDate(studyData.finalReportForecasted) + ')</div></div><div><div class="text-sm text-gray-500">Actual</div><div class="text-xl font-bold text-blue-600">' + (frA !== null ? frA : 'N/A') + '</div><div class="text-xs text-gray-500">(' + formatDate(studyData.finalReportActual) + ')</div></div></div></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"><div class="bg-white rounded-lg shadow border p-4"><h3 class="text-xs font-medium text-gray-600 mb-2">Overall Progress</h3><div class="text-2xl font-bold text-gray-800">' + progress + '%</div><div class="w-full bg-gray-200 rounded-full h-2 mt-2"><div class="bg-green-500 h-2 rounded-full" style="width: ' + progress + '%"></div></div></div><div class="bg-white rounded-lg shadow border p-4"><h3 class="text-xs font-medium text-gray-600 mb-2">Outstanding Queries</h3><div class="text-2xl font-bold text-gray-800">' + studyData.complianceMetrics.outstandingQueries + '</div><div class="text-xs text-gray-500">requires resolution</div></div><div class="bg-white rounded-lg shadow border p-4"><h3 class="text-xs font-medium text-gray-600 mb-2">eTMF Completeness</h3><div class="text-2xl font-bold text-gray-800">' + studyData.complianceMetrics.etmfCompleteness + '%</div><div class="text-xs text-gray-500">inspection ready</div></div></div><div class="bg-white rounded-lg shadow border p-6 mb-6"><h2 class="text-lg font-semibold text-gray-800 mb-4">üìä Progress by Category</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4">' + categoryProgress.map(cat => '<div class="border rounded-lg p-4"><div class="flex justify-between items-center mb-2"><h3 class="font-medium text-gray-800">' + cat.name + '</h3><span class="text-sm font-semibold text-gray-600">' + cat.percentage + '%</span></div><div class="w-full bg-gray-200 rounded-full h-2 mb-2"><div class="bg-blue-500 h-2 rounded-full" style="width: ' + cat.percentage + '%"></div></div><p class="text-xs text-gray-500">' + cat.completed + ' of ' + cat.total + ' tasks completed</p></div>').join('') + '</div></div><div class="bg-white rounded-lg shadow border p-6"><h2 class="text-lg font-semibold text-gray-800 mb-4">üìã Close-Out Tasks (' + filtered.length + ')</h2><div class="flex flex-wrap gap-3 mb-4"><div class="flex items-center gap-2"><label class="text-sm font-medium text-gray-700">Sort by:</label><select onchange="window.currentSort=this.value; render();" class="px-3 py-2 border rounded-md text-sm">' + ['deadline', 'name', 'priority', 'status', 'progress'].map(s => '<option value="' + s + '" ' + (sort === s ? 'selected' : '') + '>' + s.charAt(0).toUpperCase() + s.slice(1) + '</option>').join('') + '</select></div><div class="flex items-center gap-2"><label class="text-sm font-medium text-gray-700">Filter by:</label><select onchange="window.currentFilter.category=this.value; render();" class="px-3 py-2 border rounded-md text-sm"><option value="">All Categories</option>' + studyData.categories.map(c => '<option ' + (filter.category === c ? 'selected' : '') + '>' + c + '</option>').join('') + '</select><select onchange="window.currentFilter.priority=this.value; render();" class="px-3 py-2 border rounded-md text-sm"><option value="">All Priorities</option>' + ['Critical', 'High', 'Medium', 'Low'].map(p => '<option ' + (filter.priority === p ? 'selected' : '') + '>' + p + '</option>').join('') + '</select><select onchange="window.currentFilter.status=this.value; render();" class="px-3 py-2 border rounded-md text-sm"><option value="">All Status</option>' + ['Completed', 'In Progress', 'Not Started'].map(s => '<option ' + (filter.status === s ? 'selected' : '') + '>' + s + '</option>').join('') + '</select></div></div><div class="overflow-x-auto"><table class="w-full text-sm"><thead class="bg-gray-50 border-b"><tr><th class="text-left p-3 font-medium text-gray-600">Task</th><th class="text-left p-3 font-medium text-gray-600">Category</th><th class="text-left p-3 font-medium text-gray-600">Owner</th><th class="text-left p-3 font-medium text-gray-600">Priority</th><th class="text-left p-3 font-medium text-gray-600">Deadline</th><th class="text-left p-3 font-medium text-gray-600">Status</th><th class="text-left p-3 font-medium text-gray-600">Progress</th><th class="text-left p-3 font-medium text-gray-600">Dependencies</th><th class="text-left p-3 font-medium text-gray-600">Actions</th></tr></thead><tbody>' + filtered.map(task => {
                const deps = task.dependencies.map(id => studyData.closeoutTasks.find(t => t.id === id)?.name || 'Unknown').join(', ');
                return '<tr class="border-b hover:bg-gray-50"><td class="p-3"><div class="font-medium text-gray-800">' + task.name + '</div><div class="text-xs text-gray-500">' + task.role + '</div>' + (task.description ? '<div class="text-xs text-gray-600 mt-1 italic">' + task.description + '</div>' : '') + '</td><td class="p-3 text-gray-600">' + task.category + '</td><td class="p-3 text-gray-600">' + task.owner + '</td><td class="p-3"><span class="inline-flex px-2 py-1 rounded text-xs border font-medium ' + (task.priority === 'Critical' ? 'bg-red-100 text-red-800 border-red-300' : task.priority === 'High' ? 'bg-orange-100 text-orange-800 border-orange-300' : task.priority === 'Medium' ? 'bg-yellow-100 text-yellow-800 border-yellow-300' : 'bg-green-100 text-green-800 border-green-300') + '">' + task.priority + '</span></td><td class="p-3 text-gray-600">' + task.deadline + '</td><td class="p-3"><span class="inline-flex px-2 py-1 rounded text-xs font-medium ' + (task.status === 'Completed' ? 'bg-green-100 text-green-800' : task.status === 'In Progress' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800') + '">' + task.status + '</span></td><td class="p-3"><div class="flex items-center gap-2"><div class="w-16 bg-gray-200 rounded-full h-2"><div class="h-2 rounded-full ' + (task.status === 'Completed' ? 'bg-green-500' : task.status === 'In Progress' ? 'bg-blue-500' : 'bg-gray-300') + '" style="width: ' + task.progress + '%"></div></div><span class="text-xs text-gray-600">' + task.progress + '%</span></div></td><td class="p-3"><span class="text-xs text-gray-500" title="' + deps + '">' + (task.dependencies.length > 0 ? task.dependencies.length + ' task(s)' : 'None') + '</span></td><td class="p-3"><button onclick="editTask(' + task.id + ')" class="text-green-600 hover:text-green-800 mr-2">‚úèÔ∏è</button><button onclick="deleteTask(' + task.id + ')" class="text-red-600 hover:text-red-800">üóëÔ∏è</button></td></tr>';
            }).join('') + '</tbody></table></div></div></div>';
            updateSaveStatus();
        }

        window.currentFilter = { category: '', priority: '', status: '' };
        window.currentSort = 'deadline';
        window.editingTask = null;
        window.editingDocIndex = undefined;
        render();
        setInterval(updateSaveStatus, 10000);
    </script>
</body>
</html>
