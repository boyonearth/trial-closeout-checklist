<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trial Close-Out Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .tooltip-btn { position: relative; }
        .tooltip-btn:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 8px;
        }
        .tooltip-btn:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            margin-bottom: 2px;
        }
        
        /* Cursor pointer for clickable elements */
        .cursor-pointer {
            cursor: pointer;
        }
        
        /* Transition for smooth hover effects */
        .transition-colors {
            transition: background-color 0.2s ease;
        }
        
        /* Custom scrollbar styling */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Dark mode scrollbar */
        body.dark-mode .overflow-y-auto::-webkit-scrollbar-track {
            background: #404040;
        }
        body.dark-mode .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #666;
        }
        body.dark-mode .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        /* Background colors */
        body.dark-mode .bg-gray-50 {
            background-color: #1a1a1a !important;
        }
        body.dark-mode .bg-white {
            background-color: #2d2d2d !important;
            color: #e0e0e0 !important;
        }
        body.dark-mode .bg-gray-100 {
            background-color: #383838 !important;
        }
        body.dark-mode .bg-gray-200 {
            background-color: #404040 !important;
        }
        
        /* Text colors - make all text light */
        body.dark-mode .text-gray-800,
        body.dark-mode .text-gray-700,
        body.dark-mode .text-gray-600,
        body.dark-mode .text-gray-500,
        body.dark-mode .font-bold,
        body.dark-mode .font-semibold,
        body.dark-mode .font-medium {
            color: #e0e0e0 !important;
        }
        body.dark-mode .text-gray-400 {
            color: #b0b0b0 !important;
        }
        
        /* Borders */
        body.dark-mode .border,
        body.dark-mode .border-b,
        body.dark-mode .border-t,
        body.dark-mode .border-l-4,
        body.dark-mode .border-gray-200 {
            border-color: #505050 !important;
        }
        
        /* Critical Path - Red section with HIGH CONTRAST */
        body.dark-mode .bg-red-50 {
            background-color: #7f1d1d !important;
        }
        body.dark-mode .bg-red-100 {
            background-color: #991b1b !important;
        }
        body.dark-mode .border-red-200,
        body.dark-mode .border-red-500 {
            border-color: #ef4444 !important;
        }
        body.dark-mode .text-red-900,
        body.dark-mode .text-red-800,
        body.dark-mode .text-red-700 {
            color: #fecaca !important;
        }
        body.dark-mode .text-red-600 {
            color: #fca5a5 !important;
        }
        
        /* Ready section - Yellow with HIGH CONTRAST */
        body.dark-mode .bg-yellow-50 {
            background-color: #854d0e !important;
        }
        body.dark-mode .bg-yellow-100 {
            background-color: #a16207 !important;
        }
        body.dark-mode .border-yellow-200 {
            border-color: #facc15 !important;
        }
        body.dark-mode .text-yellow-600,
        body.dark-mode .text-yellow-800 {
            color: #fef08a !important;
        }
        
        /* Orange section with HIGH CONTRAST */
        body.dark-mode .bg-orange-50 {
            background-color: #9a3412 !important;
        }
        body.dark-mode .bg-orange-100 {
            background-color: #c2410c !important;
        }
        body.dark-mode .text-orange-600,
        body.dark-mode .text-orange-800 {
            color: #fed7aa !important;
        }
        
        /* Green section with HIGH CONTRAST */
        body.dark-mode .bg-green-50 {
            background-color: #14532d !important;
        }
        body.dark-mode .bg-green-100 {
            background-color: #166534 !important;
        }
        body.dark-mode .border-green-300 {
            border-color: #22c55e !important;
        }
        body.dark-mode .text-green-800,
        body.dark-mode .text-green-600 {
            color: #bbf7d0 !important;
        }
        
        /* Blue section with HIGH CONTRAST */
        body.dark-mode .bg-blue-50 {
            background-color: #1e3a8a !important;
        }
        body.dark-mode .bg-blue-100 {
            background-color: #1e40af !important;
        }
        body.dark-mode .border-blue-300,
        body.dark-mode .border-blue-200 {
            border-color: #3b82f6 !important;
        }
        body.dark-mode .text-blue-800,
        body.dark-mode .text-blue-600 {
            color: #bfdbfe !important;
        }
        
        /* Progress bars - BRIGHT colors */
        body.dark-mode .bg-green-500 {
            background-color: #22c55e !important;
        }
        body.dark-mode .bg-blue-500 {
            background-color: #3b82f6 !important;
        }
        body.dark-mode .bg-gray-300 {
            background-color: #6b7280 !important;
        }
        
        /* Input fields */
        body.dark-mode input,
        body.dark-mode textarea,
        body.dark-mode select {
            background-color: #383838 !important;
            color: #e0e0e0 !important;
            border-color: #505050 !important;
        }
        body.dark-mode input::placeholder,
        body.dark-mode textarea::placeholder {
            color: #9ca3af !important;
        }
        
        /* Hover states */
        body.dark-mode .hover\:bg-gray-50:hover {
            background-color: #404040 !important;
        }
        body.dark-mode .hover\:bg-gray-200:hover {
            background-color: #505050 !important;
        }
        body.dark-mode .hover\:bg-blue-50:hover {
            background-color: #1e40af !important;
        }
        body.dark-mode .hover\:bg-blue-100:hover {
            background-color: #1e40af !important;
        }
        body.dark-mode .hover\:bg-cyan-200:hover {
            background-color: #0e7490 !important;
        }
        body.dark-mode .hover\:bg-teal-700:hover {
            background-color: #0f766e !important;
        }
        body.dark-mode .hover\:bg-indigo-200:hover {
            background-color: #4338ca !important;
        }
        body.dark-mode .hover\:bg-purple-200:hover {
            background-color: #7c3aed !important;
        }
        body.dark-mode .hover\:bg-orange-200:hover {
            background-color: #c2410c !important;
        }
        body.dark-mode .hover\:bg-yellow-200:hover {
            background-color: #a16207 !important;
        }
        body.dark-mode .hover\:bg-green-700:hover {
            background-color: #15803d !important;
        }
        body.dark-mode .hover\:bg-yellow-100:hover {
            background-color: #b45309 !important;
        }
        body.dark-mode .hover\:bg-red-100:hover {
            background-color: #b91c1c !important;
        }
        body.dark-mode .hover\:bg-red-50:hover {
            background-color: #991b1b !important;
        }
        
        /* Button colors */
        body.dark-mode .bg-cyan-100 {
            background-color: #164e63 !important;
            color: #e0e0e0 !important;
        }
        body.dark-mode .bg-teal-600 {
            background-color: #0d9488 !important;
        }
        body.dark-mode .bg-indigo-100 {
            background-color: #3730a3 !important;
            color: #e0e0e0 !important;
        }
        body.dark-mode .bg-purple-100 {
            background-color: #6b21a8 !important;
            color: #e0e0e0 !important;
        }
        body.dark-mode .bg-orange-100 {
            background-color: #c2410c !important;
            color: #e0e0e0 !important;
        }
        body.dark-mode .bg-yellow-100 {
            background-color: #a16207 !important;
            color: #e0e0e0 !important;
        }
        body.dark-mode .bg-green-100 {
            background-color: #166534 !important;
            color: #e0e0e0 !important;
        }
        body.dark-mode .bg-green-600 {
            background-color: #16a34a !important;
        }
        body.dark-mode .bg-blue-600 {
            background-color: #2563eb !important;
        }
        body.dark-mode .bg-red-600 {
            background-color: #dc2626 !important;
        }
        
        /* Modal and shadows */
        body.dark-mode .shadow {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5) !important;
        }
        body.dark-mode .fixed {
            background-color: rgba(0, 0, 0, 0.9) !important;
        }
        
        /* Ensure all interactive text is visible */
        body.dark-mode button {
            color: #e0e0e0;
        }
        body.dark-mode .text-white {
            color: #ffffff !important;
        }
        
        /* Additional comprehensive dark mode fixes */
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, body.dark-mode h4 {
            color: #e0e0e0 !important;
        }
        body.dark-mode label {
            color: #d0d0d0 !important;
        }
        body.dark-mode p {
            color: #b0b0b0 !important;
        }
        body.dark-mode div {
            color: inherit;
        }
        
        /* Button backgrounds - make sure colored buttons are visible */
        body.dark-mode .bg-cyan-100 {
            background-color: #164e63 !important;
            color: #ffffff !important;
        }
        body.dark-mode .bg-teal-600 {
            background-color: #0d9488 !important;
            color: #ffffff !important;
        }
        body.dark-mode .bg-indigo-100 {
            background-color: #4338ca !important;
            color: #ffffff !important;
        }
        body.dark-mode .bg-purple-100 {
            background-color: #7c3aed !important;
            color: #ffffff !important;
        }
        body.dark-mode .bg-orange-100 {
            background-color: #ea580c !important;
            color: #ffffff !important;
        }
        body.dark-mode .bg-yellow-100 {
            background-color: #d97706 !important;
            color: #ffffff !important;
        }
        
        /* Text size visibility */
        body.dark-mode .text-2xl {
            color: #e0e0e0 !important;
        }
        
        /* Link display styling in dark mode */
        body.dark-mode .bg-blue-50 {
            background-color: #1e3a8a !important;
        }
        body.dark-mode .border-blue-200 {
            background-color: #2563eb !important;
        }
        body.dark-mode .text-blue-600 {
            color: #93c5fd !important;
        }
        body.dark-mode .hover\:text-blue-800:hover {
            color: #bfdbfe !important;
        }
        body.dark-mode .bg-red-100 {
            background-color: #7f1d1d !important;
        }
        body.dark-mode .hover\:bg-red-200:hover {
            background-color: #991b1b !important;
        }
        body.dark-mode .bg-green-50 {
            background-color: #14532d !important;
        }
        body.dark-mode .border-green-200 {
            border-color: #22c55e !important;
        }
        body.dark-mode .bg-blue-100 {
            background-color: #1e3a8a !important;
        }
        body.dark-mode .text-blue-600 {
            color: #93c5fd !important;
        }
        body.dark-mode .hover\:bg-blue-200:hover {
            background-color: #1e40af !important;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>
    <script>
        const STORAGE_KEY = 'trial_closeout_enhanced_v8';
        
        const DEFAULT_TEMPLATES = [
            {
                id: 1,
                name: "Study Manager Close-Out",
                description: "Complete trial closeout workflow - 19 tasks",
                tasks: [
                    { name: "Last Patient Visit Completed", category: "Data Management", role: "Clinical Data Team Lead", priority: "Critical", dependencies: [] },
                    { name: "End of Trial Regulatory Notification", category: "Regulatory", role: "Regulatory Affairs", priority: "Critical", dependencies: [1] },
                    { name: "Close Out Monitoring Visits", category: "Quality", role: "Clinical Research Associate", priority: "High", dependencies: [1] },
                    { name: "Close Open Actions (Queries, Deviations)", category: "Data Management", role: "Data Manager", priority: "Critical", dependencies: [1] },
                    { name: "Database Lock", category: "Data Management", role: "Clinical Data Manager", priority: "Critical", dependencies: [4] },
                    { name: "DBL Decommissioning", category: "Data Management", role: "Data Manager", priority: "High", dependencies: [5] },
                    { name: "eCRF Download", category: "Data Management", role: "Data Manager", priority: "High", dependencies: [5] },
                    { name: "Sites Decommissioning", category: "Site Management", role: "Site Manager", priority: "Medium", dependencies: [3] },
                    { name: "Clinical Study Report", category: "Regulatory", role: "Medical Writer", priority: "Critical", dependencies: [5] },
                    { name: "Registry Updates", category: "Regulatory", role: "Regulatory Affairs", priority: "High", dependencies: [9] },
                    { name: "Plain Language Summary", category: "Regulatory", role: "Medical Writer", priority: "Medium", dependencies: [9] },
                    { name: "Site Finances Closeout", category: "Finance", role: "Finance Team", priority: "High", dependencies: [3] },
                    { name: "Purchase Orders Closeout", category: "Finance", role: "Finance Team", priority: "High", dependencies: [12] },
                    { name: "Budget Closeout", category: "Finance", role: "Project Manager", priority: "High", dependencies: [13] },
                    { name: "SharePoint Closeout", category: "Documentation", role: "Project Manager", priority: "Medium", dependencies: [9] },
                    { name: "Document System Milestones Verification", category: "Documentation", role: "Clinical Data Team Lead", priority: "High", dependencies: [1] },
                    { name: "Document Transfer to Archive", category: "Documentation", role: "Document Manager", priority: "High", dependencies: [9] },
                    { name: "eTMF Archival Initiated", category: "Documentation", role: "TMF Specialist", priority: "Critical", dependencies: [17] },
                    { name: "eTMF Archival Completed", category: "Documentation", role: "TMF Specialist", priority: "Critical", dependencies: [18] }
                ]
            },
            {
                id: 2,
                name: "Verification Activities",
                description: "Verification and confirmation tasks - 5 tasks",
                tasks: [
                    { name: "Lab Equipment Return Confirmed", category: "Quality", role: "Clinical Lab Services", priority: "Medium", dependencies: [] },
                    { name: "Document System Milestones Complete", category: "Quality", role: "Clinical Data Team Lead", priority: "High", dependencies: [] },
                    { name: "Device Return & eCOA/EDC Decommission", category: "Data Management", role: "Data Manager", priority: "High", dependencies: [] },
                    { name: "Sponsor eTMF Ready for Archival", category: "Documentation", role: "TMF Specialist", priority: "Critical", dependencies: [] },
                    { name: "Study Workspace Closeout", category: "Documentation", role: "Project Manager", priority: "Medium", dependencies: [] }
                ]
            },
            {
                id: 3,
                name: "IND/Asset Termination",
                description: "Regulatory asset termination workflow - 15 tasks",
                tasks: [
                    { name: "Confirm LPV Occurred", category: "Data Management", role: "Clinical Data Team Lead", priority: "Critical", dependencies: [] },
                    { name: "IND Inactivated or Closed", category: "Regulatory", role: "Regulatory Affairs", priority: "Critical", dependencies: [1] },
                    { name: "Publication List Updated", category: "Regulatory", role: "Global Study Coordinator", priority: "Medium", dependencies: [1] },
                    { name: "Check Ongoing Publications", category: "Regulatory", role: "Global Study Coordinator", priority: "Medium", dependencies: [3] },
                    { name: "All Milestones Updated in Systems", category: "Data Management", role: "Clinical Data Team Lead", priority: "High", dependencies: [1] },
                    { name: "Trial Closed in Document System", category: "Data Management", role: "Clinical Data Team Lead", priority: "High", dependencies: [5] },
                    { name: "SharePoint Closed", category: "Documentation", role: "Project Manager", priority: "Medium", dependencies: [6] },
                    { name: "PO and Budgets Closed", category: "Finance", role: "Project Manager", priority: "High", dependencies: [6] },
                    { name: "Investigational Product Discarded", category: "Safety", role: "Clinical Trial Materials", priority: "High", dependencies: [1] },
                    { name: "IB/RP Completed", category: "Regulatory", role: "Medical Writer", priority: "Critical", dependencies: [1] },
                    { name: "NoAR Completed", category: "Regulatory", role: "Medical Writer", priority: "Critical", dependencies: [10] },
                    { name: "CSR Completed", category: "Regulatory", role: "Medical Writer", priority: "Critical", dependencies: [11] },
                    { name: "DSUR Completed", category: "Regulatory", role: "Medical Writer", priority: "Critical", dependencies: [12] },
                    { name: "IND Submission for Deactivation", category: "Regulatory", role: "Regulatory Affairs", priority: "Critical", dependencies: [13] },
                    { name: "Team Communication - Asset Closed", category: "Communication", role: "Clinical Data Team Lead", priority: "Medium", dependencies: [14] }
                ]
            }
        ];

            const initialData = {
            version: "8.0",
            studyId: "STUDY-1234-001",
            studyName: "Enter Your Study Name",
            protocolName: "PROTO-ABC-001",
            trialType: "Interventional",
            lpfvDateForecasted: "",
            lpfvDateActual: "",
            targetDbLockForecasted: "",
            targetDbLockActual: "",
            finalReportForecasted: "",
            finalReportActual: "",
            closeoutTasks: [],
            categories: ["Data Management", "Safety", "Quality", "Biostatistics", "Regulatory", "Documentation", "Finance", "Site Management", "Communication"],
            complianceMetrics: { outstandingQueries: 0, etmfCompleteness: 0, inspectionReadiness: 0 },
            documents: [],
            templates: DEFAULT_TEMPLATES,
            loadedTemplate: null,
            currentView: 'table',
            searchQuery: '',
            theme: 'light'
        };

        let studyData = loadData();
        let lastSaved = new Date();
        
        // Theme functions
        function applyTheme() {
            if (studyData.theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }
        
        function toggleTheme(newTheme) {
            studyData.theme = newTheme;
            applyTheme();
            saveData();
        }
        
        // Apply theme on page load
        applyTheme();

        function loadData() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    if (!data.documents) data.documents = [];
                    if (!data.currentView) data.currentView = 'table';
                    if (!data.templates) data.templates = DEFAULT_TEMPLATES;
                    if (!data.loadedTemplate) data.loadedTemplate = null;
                    if (!data.theme) data.theme = 'light';
                    return data;
                }
            } catch (e) { console.error('Load error:', e); }
            return initialData;
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(studyData));
                lastSaved = new Date();
                updateSaveStatus();
            } catch (e) { console.error('Save error:', e); }
        }

        function updateSaveStatus() {
            const diff = Math.floor((new Date() - lastSaved) / 1000);
            let text = diff < 10 ? 'just now' : diff < 60 ? diff + 's ago' : diff < 3600 ? Math.floor(diff / 60) + 'm ago' : lastSaved.toLocaleTimeString();
            const el = document.getElementById('save-status');
            if (el) el.textContent = 'Auto-saved ' + text;
        }

        function calculateDays(dateStr) {
            if (!dateStr) return null;
            return Math.floor((new Date() - new Date(dateStr)) / 86400000);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function getTaskStatus(task) {
            if (task.status === 'Completed') return 'completed';
            const allDeps = task.dependencies.every(depId => {
                const dep = studyData.closeoutTasks.find(t => t.id === depId);
                return dep && dep.status === 'Completed';
            });
            if (!allDeps && task.dependencies.length > 0) return 'blocked';
            if (task.status === 'In Progress') return 'inprogress';
            return 'ready';
        }

        function getStatusColor(status) {
            if (status === 'completed') return 'bg-green-100 text-green-800 border-green-300';
            if (status === 'inprogress') return 'bg-blue-100 text-blue-800 border-blue-300';
            if (status === 'ready') return 'bg-yellow-100 text-yellow-800 border-yellow-300';
            return 'bg-red-100 text-red-800 border-red-300';
        }

        function getStatusIcon(status) {
            if (status === 'completed') return 'üü¢';
            if (status === 'inprogress') return 'üîµ';
            if (status === 'ready') return 'üü°';
            return 'üî¥';
        }

        function getStatusLabel(status) {
            if (status === 'completed') return 'Completed';
            if (status === 'inprogress') return 'In Progress';
            if (status === 'ready') return 'Ready';
            return 'Blocked';
        }

        function loadTemplate(templateId) {
            if (!confirm('This will replace all current tasks. Continue?')) return;
            const template = studyData.templates.find(t => t.id === templateId);
            if (!template) return;
            
            const today = new Date();
            const tasks = template.tasks.map((t, idx) => ({
                id: idx + 1,
                name: t.name,
                description: '',
                category: t.category,
                owner: '',
                role: t.role,
                deadline: new Date(today.getTime() + (idx + 1) * 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                status: 'Not Started',
                priority: t.priority,
                progress: 0,
                dependencies: t.dependencies,
                links: t.links || (t.link ? [{name: 'Link', url: t.link}] : []),
                instructions: t.instructions || ''
            }));
            
            studyData.closeoutTasks = tasks;
            studyData.loadedTemplate = template.name;
            saveData();
            render();
            document.querySelector('.fixed').remove();
            alert('Template loaded: ' + template.name + ' (' + tasks.length + ' tasks)');
        }

        function manageTemplates() {
            showModal('template-manager');
        }

        function addNewTemplate() {
            window.editingTemplateId = null;
            showModal('template-form');
        }

        function editTemplate(templateId) {
            window.editingTemplateId = templateId;
            showModal('template-form');
        }

        function deleteTemplate(templateId) {
            if (confirm('Delete this template permanently?')) {
                studyData.templates = studyData.templates.filter(t => t.id !== templateId);
                saveData();
                showModal('template-manager');
            }
        }

        function saveTemplateMetadata() {
            const name = document.getElementById('templateName').value;
            const description = document.getElementById('templateDescription').value;
            if (!name) { alert('Template name required'); return; }
            
            if (window.editingTemplateId) {
                const template = studyData.templates.find(t => t.id === window.editingTemplateId);
                template.name = name;
                template.description = description;
            } else {
                const newId = Math.max(0, ...studyData.templates.map(t => t.id)) + 1;
                studyData.templates.push({
                    id: newId,
                    name: name,
                    description: description,
                    tasks: []
                });
                window.editingTemplateId = newId;
            }
            saveData();
            showModal('template-task-manager');
        }

        function manageTemplateTasks(templateId) {
            window.editingTemplateId = templateId;
            showModal('template-task-manager');
        }

        function addTemplateTask() {
            window.editingTemplateTaskIndex = null;
            showModal('template-task-form');
        }

        function editTemplateTask(taskIndex) {
            window.editingTemplateTaskIndex = taskIndex;
            showModal('template-task-form');
        }

        function deleteTemplateTask(taskIndex) {
            if (confirm('Delete this task from template?')) {
                const template = studyData.templates.find(t => t.id === window.editingTemplateId);
                template.tasks.splice(taskIndex, 1);
                // Update dependencies
                template.tasks.forEach(t => {
                    t.dependencies = t.dependencies.filter(dep => dep !== (taskIndex + 1)).map(dep => dep > (taskIndex + 1) ? dep - 1 : dep);
                });
                saveData();
                showModal('template-task-manager');
            }
        }

        function saveTemplateTask() {
            const name = document.getElementById('tempTaskName').value;
            const category = document.getElementById('tempTaskCategory').value;
            const role = document.getElementById('tempTaskRole').value;
            const priority = document.getElementById('tempTaskPriority').value;
            
            if (!name || !category || !role) { alert('Fill required fields'); return; }
            
            const template = studyData.templates.find(t => t.id === window.editingTemplateId);
            const depsSelect = document.getElementById('tempTaskDependencies');
            const dependencies = Array.from(depsSelect.selectedOptions).map(opt => parseInt(opt.value));
            
            const task = { name, category, role, priority, dependencies };
            
            if (window.editingTemplateTaskIndex !== null) {
                template.tasks[window.editingTemplateTaskIndex] = task;
            } else {
                template.tasks.push(task);
            }
            
            saveData();
            window.editingTemplateTaskIndex = null;
            showModal('template-task-manager');
        }

        function getCriticalPath() {
            return studyData.closeoutTasks.filter(task => {
                if (task.status === 'Completed') return false;
                const blocking = studyData.closeoutTasks.filter(t => t.dependencies.includes(task.id) && t.status !== 'Completed');
                return blocking.length > 0;
            }).sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
        }

        function getReadyTasks() {
            return studyData.closeoutTasks.filter(task => {
                if (task.status === 'Completed') return false;
                const allDepsComplete = task.dependencies.every(depId => {
                    const dep = studyData.closeoutTasks.find(t => t.id === depId);
                    return dep && dep.status === 'Completed';
                });
                return allDepsComplete;
            }).sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
        }

        function getBlockedTasks() {
            return studyData.closeoutTasks.filter(task => {
                if (task.status === 'Completed') return false;
                const hasIncompleteDeps = task.dependencies.some(depId => {
                    const dep = studyData.closeoutTasks.find(t => t.id === depId);
                    return !dep || dep.status !== 'Completed';
                });
                return hasIncompleteDeps && task.dependencies.length > 0;
            });
        }

        function exportToExcel() {
            const ws_data = [['Trial Close-Out Checklist'], ['Study: ' + studyData.studyName], ['Study ID: ' + studyData.studyId], [], ['Task', 'Description', 'Category', 'Owner', 'Role', 'Priority', 'Deadline', 'Status', 'Smart Status', 'Progress', 'Dependencies']];
            studyData.closeoutTasks.forEach(task => {
                const deps = task.dependencies.map(id => studyData.closeoutTasks.find(x => x.id === id)?.name || id).join('; ');
                const smartStatus = getStatusLabel(getTaskStatus(task));
                ws_data.push([task.name, task.description || '', task.category, task.owner, task.role, task.priority, task.deadline, task.status, smartStatus, task.progress + '%', deps]);
            });
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Tasks");
            XLSX.writeFile(wb, studyData.studyId + '_checklist.xlsx');
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16); doc.text('Trial Close-Out Checklist', 20, 20);
            doc.setFontSize(10); doc.text('Study: ' + studyData.studyName, 20, 30);
            let y = 40; doc.setFontSize(9);
            studyData.closeoutTasks.forEach(task => {
                if (y > 270) { doc.addPage(); y = 20; }
                doc.text(task.name + ' - ' + getStatusLabel(getTaskStatus(task)), 20, y);
                y += 6;
            });
            doc.save(studyData.studyId + '_checklist.pdf');
        }

        function exportToWord() {
            let html = '<html><body><h1>Trial Close-Out Checklist</h1><p><b>Study:</b> ' + studyData.studyName + '</p><table border="1" cellpadding="8" style="border-collapse: collapse; width: 100%;"><tr><th>Task</th><th>Category</th><th>Owner</th><th>Status</th><th>Progress</th></tr>';
            studyData.closeoutTasks.forEach(task => {
                html += '<tr><td>' + task.name + '</td><td>' + task.category + '</td><td>' + task.owner + '</td><td>' + getStatusLabel(getTaskStatus(task)) + '</td><td>' + task.progress + '%</td></tr>';
            });
            html += '</table></body></html>';
            const blob = new Blob([html], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url; link.download = studyData.studyId + '_checklist.doc'; link.click();
            URL.revokeObjectURL(url);
        }

        function exportJSON() {
            const blob = new Blob([JSON.stringify(studyData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url; link.download = studyData.studyId + '_backup.json'; link.click();
            URL.revokeObjectURL(url);
        }

        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (imported.studyId) {
                            studyData = imported;
                            if (!studyData.documents) studyData.documents = [];
                            if (!studyData.templates) studyData.templates = DEFAULT_TEMPLATES;
                            saveData(); render();
                            alert('Restored!');
                        }
                    } catch (err) { alert('Error'); }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function showModal(type, data) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto p-4';
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
            let content = '';

            if (type === 'category-details') {
                const categoryName = data;
                const categoryTasks = studyData.closeoutTasks.filter(t => t.category === categoryName);
                const completed = categoryTasks.filter(t => t.status === 'Completed');
                const pending = categoryTasks.filter(t => t.status !== 'Completed');
                const pendingCount = pending.length;
                
                content = '<div class="bg-white rounded-lg p-6 max-w-3xl w-full max-h-screen overflow-y-auto"><h3 class="text-xl font-bold mb-4">' + categoryName + '</h3><div class="grid grid-cols-3 gap-4 mb-6"><div class="bg-blue-50 border rounded p-3"><div class="text-sm text-gray-600">Total Tasks</div><div class="text-2xl font-bold text-gray-800">' + categoryTasks.length + '</div></div><div class="bg-green-50 border rounded p-3"><div class="text-sm text-gray-600">Completed</div><div class="text-2xl font-bold text-green-600">' + completed.length + '</div></div><div class="bg-orange-50 border rounded p-3"><div class="text-sm text-gray-600">Pending</div><div class="text-2xl font-bold text-orange-600">' + pendingCount + '</div></div></div><h4 class="font-semibold mb-3">Pending Tasks (' + pendingCount + '):</h4><div class="space-y-2 mb-4">' + (pendingCount === 0 ? '<p class="text-gray-500 text-center py-4">All tasks completed! üéâ</p>' : pending.map(task => {
                    const smartStatus = getTaskStatus(task);
                    return '<div class="border rounded p-3 hover:bg-gray-50 cursor-pointer" onclick="this.closest(\'.fixed\').remove(); editTask(' + task.id + ')"><div class="flex justify-between items-start"><div class="flex-1"><div class="font-medium text-gray-800">' + task.name + '</div><div class="text-xs text-gray-600 mt-1">Owner: ' + (task.owner || 'Unassigned') + ' | Deadline: ' + task.deadline + '</div></div><span class="px-2 py-1 rounded text-xs border font-medium ' + getStatusColor(smartStatus) + '">' + getStatusIcon(smartStatus) + ' ' + getStatusLabel(smartStatus) + '</span></div></div>';
                }).join('')) + '</div><h4 class="font-semibold mb-3">Completed Tasks (' + completed.length + '):</h4><div class="space-y-2">' + (completed.length === 0 ? '<p class="text-gray-500 text-center py-4">No completed tasks yet</p>' : completed.map(task => '<div class="border rounded p-3 bg-green-50"><div class="font-medium text-gray-800 line-through opacity-60">' + task.name + '</div><div class="text-xs text-gray-600 mt-1">Owner: ' + (task.owner || 'Unassigned') + ' | Deadline: ' + task.deadline + '</div></div>').join('')) + '</div><button onclick="this.closest(\'.fixed\').remove()" class="mt-6 w-full px-4 py-2 border rounded-md">Close</button></div>';
            } else if (type === 'templates') {
                content = '<div class="bg-white rounded-lg p-6 max-w-2xl w-full"><h3 class="text-xl font-bold mb-4">üìã Load Template</h3><div class="mb-4 flex justify-between items-center"><p class="text-sm text-gray-600">Select a template to load tasks</p><button onclick="manageTemplates()" class="px-3 py-2 bg-blue-600 text-white rounded-md text-sm">Manage Templates</button></div><div class="space-y-3">' + studyData.templates.map(template => '<button onclick="loadTemplate(' + template.id + ')" class="w-full px-4 py-3 bg-blue-50 hover:bg-blue-100 border rounded-md text-left"><div class="font-medium">' + template.name + '</div><div class="text-xs text-gray-500">' + template.description + ' (' + template.tasks.length + ' tasks)</div></button>').join('') + '</div><button onclick="this.closest(\'.fixed\').remove()" class="mt-4 w-full px-4 py-2 border rounded-md">Cancel</button></div>';
            } else if (type === 'template-manager') {
                content = '<div class="bg-white rounded-lg p-6 max-w-3xl w-full max-h-screen overflow-y-auto"><h3 class="text-xl font-bold mb-4">Manage Templates</h3><div class="mb-4"><button onclick="addNewTemplate()" class="px-4 py-2 bg-green-600 text-white rounded-md">+ Create New Template</button></div><div class="space-y-3">' + studyData.templates.map(template => '<div class="border rounded-lg p-4 hover:bg-gray-50"><div class="flex justify-between items-start"><div class="flex-1"><h4 class="font-semibold text-gray-800">' + template.name + '</h4><p class="text-sm text-gray-600 mt-1">' + template.description + '</p><p class="text-xs text-gray-500 mt-2">' + template.tasks.length + ' tasks configured</p></div><div class="flex gap-2"><button onclick="manageTemplateTasks(' + template.id + ')" class="px-3 py-2 bg-blue-100 text-blue-700 rounded-md text-sm">Tasks</button><button onclick="editTemplate(' + template.id + ')" class="text-green-600 hover:text-green-800 text-xl">‚úèÔ∏è</button><button onclick="deleteTemplate(' + template.id + ')" class="text-red-600 hover:text-red-800 text-xl">üóëÔ∏è</button></div></div></div>').join('') + '</div><button onclick="this.closest(\'.fixed\').remove()" class="mt-4 w-full px-4 py-2 border rounded-md">Close</button></div>';
            } else if (type === 'template-form') {
                const isEdit = window.editingTemplateId;
                const template = isEdit ? studyData.templates.find(t => t.id === window.editingTemplateId) : { name: '', description: '' };
                content = '<div class="bg-white rounded-lg p-6 max-w-2xl w-full"><h3 class="text-xl font-bold mb-4">' + (isEdit ? 'Edit' : 'Create') + ' Template</h3><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Template Name *</label><input type="text" id="templateName" value="' + (template.name || '') + '" class="w-full px-3 py-2 border rounded-md" placeholder="e.g., Study Manager Close-Out"></div><div><label class="block text-sm font-medium mb-1">Description</label><textarea id="templateDescription" class="w-full px-3 py-2 border rounded-md" rows="2" placeholder="Brief description of this template">' + (template.description || '') + '</textarea></div></div><div class="flex justify-end gap-3 mt-6"><button onclick="this.closest(\'.fixed\').remove(); window.editingTemplateId = null;" class="px-4 py-2 border rounded-md">Cancel</button><button onclick="saveTemplateMetadata()" class="px-4 py-2 bg-green-600 text-white rounded-md">' + (isEdit ? 'Next: Edit Tasks' : 'Next: Add Tasks') + '</button></div></div>';
            } else if (type === 'template-task-manager') {
                const template = studyData.templates.find(t => t.id === window.editingTemplateId);
                content = '<div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-screen overflow-y-auto"><h3 class="text-xl font-bold mb-4">Tasks in "' + template.name + '"</h3><div class="mb-4"><button onclick="addTemplateTask()" class="px-4 py-2 bg-green-600 text-white rounded-md">+ Add Task</button></div><div class="space-y-2">' + (template.tasks.length === 0 ? '<p class="text-gray-500 text-center py-8">No tasks yet. Click "Add Task" to start building this template.</p>' : template.tasks.map((task, idx) => '<div class="border rounded-lg p-4 hover:bg-gray-50"><div class="flex justify-between items-start"><div class="flex-1"><div class="flex items-center gap-2"><span class="text-gray-500 font-mono text-sm">#' + (idx + 1) + '</span><h4 class="font-medium text-gray-800">' + task.name + '</h4></div><div class="flex gap-4 mt-2 text-xs text-gray-600"><span>Category: ' + task.category + '</span><span>Role: ' + task.role + '</span><span>Priority: ' + task.priority + '</span>' + (task.dependencies.length > 0 ? '<span>Depends on: #' + task.dependencies.join(', #') + '</span>' : '') + '</div></div><div class="flex gap-2"><button onclick="editTemplateTask(' + idx + ')" class="text-green-600 hover:text-green-800 text-xl">‚úèÔ∏è</button><button onclick="deleteTemplateTask(' + idx + ')" class="text-red-600 hover:text-red-800 text-xl">üóëÔ∏è</button></div></div></div>').join('')) + '</div><div class="flex justify-end gap-3 mt-6"><button onclick="manageTemplates()" class="px-4 py-2 border rounded-md">Back to Templates</button><button onclick="this.closest(\'.fixed\').remove(); window.editingTemplateId = null;" class="px-4 py-2 bg-blue-600 text-white rounded-md">Done</button></div></div>';
            } else if (type === 'template-task-form') {
                const template = studyData.templates.find(t => t.id === window.editingTemplateId);
                const isEdit = window.editingTemplateTaskIndex !== null;
                const task = isEdit ? template.tasks[window.editingTemplateTaskIndex] : { name: '', category: studyData.categories[0], role: '', priority: 'Medium', dependencies: [], link: '', instructions: '' };
                content = '<div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-screen overflow-y-auto"><h3 class="text-xl font-bold mb-4">' + (isEdit ? 'Edit' : 'Add') + ' Template Task</h3><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Task Name *</label><input type="text" id="tempTaskName" value="' + (task.name || '') + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Instructions</label><textarea id="tempTaskInstructions" class="w-full px-3 py-2 border rounded-md" rows="3" placeholder="How to complete this task...">' + (task.instructions || '') + '</textarea></div><div><label class="block text-sm font-medium mb-1">Link (URL)</label><input type="url" id="tempTaskLink" value="' + (task.link || '') + '" class="w-full px-3 py-2 border rounded-md" placeholder="https://"></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Category *</label><select id="tempTaskCategory" class="w-full px-3 py-2 border rounded-md">' + studyData.categories.map(c => '<option ' + (c === task.category ? 'selected' : '') + '>' + c + '</option>').join('') + '</select></div><div><label class="block text-sm font-medium mb-1">Priority *</label><select id="tempTaskPriority" class="w-full px-3 py-2 border rounded-md">' + ['Critical', 'High', 'Medium', 'Low'].map(p => '<option ' + (p === task.priority ? 'selected' : '') + '>' + p + '</option>').join('') + '</select></div></div><div><label class="block text-sm font-medium mb-1">Role *</label><input type="text" id="tempTaskRole" value="' + (task.role || '') + '" class="w-full px-3 py-2 border rounded-md" placeholder="e.g., Data Manager"></div><div><label class="block text-sm font-medium mb-1">Dependencies (Task Numbers)</label><select id="tempTaskDependencies" multiple class="w-full px-3 py-2 border rounded-md" style="height: 120px">' + template.tasks.map((t, i) => (!isEdit || i !== window.editingTemplateTaskIndex) ? '<option value="' + (i + 1) + '" ' + (task.dependencies && task.dependencies.includes(i + 1) ? 'selected' : '') + '">#' + (i + 1) + ' - ' + t.name + '</option>' : '').join('') + '</select><p class="text-xs text-gray-500">Select tasks that must be completed before this one. Hold Ctrl/Cmd for multiple.</p></div></div><div class="flex justify-end gap-3 mt-6"><button onclick="showModal(\'template-task-manager\')" class="px-4 py-2 border rounded-md">Cancel</button><button onclick="saveTemplateTask()" class="px-4 py-2 bg-green-600 text-white rounded-md">Save Task</button></div></div>';
            } else             if (type === 'help') {
                content = '<div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-screen overflow-y-auto"><h3 class="text-2xl font-bold mb-6">üìñ Complete User Guide</h3><div class="space-y-6"><div class="bg-blue-50 border-l-4 border-blue-500 p-4"><h4 class="font-bold text-blue-900 mb-2">‚ö†Ô∏è CRITICAL: Backup Your Data Weekly!</h4><p class="text-sm text-blue-800">Your data is stored ONLY on your computer\'s browser. Create weekly backups using the Backup icon to prevent data loss!</p></div><div><h4 class="font-semibold text-lg mb-2">‚úÖ What This Dashboard Does</h4><ul class="list-disc list-inside text-sm text-gray-700 space-y-1"><li>Track all trial close-out tasks with deadlines, priorities, and dependencies</li><li>Monitor progress by regulatory category</li><li>Manage compliance metrics (queries, eTMF, inspection readiness)</li><li>Track key milestone dates (LPFV, DB Lock, Final Report - both forecast and actual)</li><li>Store and organize trial documents with file attachments</li><li>Auto-save all changes to your browser</li><li>Export reports in Excel, PDF, or Word format</li><li>Load pre-configured task templates or create your own custom templates</li><li>Smart status system shows which tasks are blocked vs ready to start</li><li>Critical path tracking highlights tasks blocking others</li><li>Visual workflow and timeline views</li></ul></div><div><h4 class="font-semibold text-lg mb-2">‚ùå What This Dashboard Does NOT Do</h4><ul class="list-disc list-inside text-sm text-gray-700 space-y-1"><li><strong>NO team collaboration</strong> - Each user has completely separate data</li><li><strong>NO cloud storage</strong> - Data is stored only on your computer, not in any cloud</li><li><strong>NO email alerts</strong> - You must manually track deadlines and set your own reminders</li><li><strong>NO multi-device sync</strong> - Must use same browser on same computer</li><li><strong>NO automatic backups</strong> - You must manually create backups</li><li><strong>NO system integration</strong> - Does not connect to CTMS, EDC, eTMF, or other systems</li><li><strong>NO real-time updates</strong> - Updates only when you refresh the page</li></ul></div><div><h4 class="font-semibold text-lg mb-2">üöÄ Quick Start Guide (5 Minutes)</h4><div class="bg-gray-50 p-4 rounded text-sm space-y-2"><p><strong>Step 1: Settings</strong><br>Click Settings icon (‚öôÔ∏è) ‚Üí Enter study information (Study ID, Name, Protocol, Dates) ‚Üí Save</p><p><strong>Step 2: Load Template or Add Tasks</strong><br>Option A: Click Templates icon (üìã) ‚Üí Choose template ‚Üí Tasks load instantly<br>Option B: Click "+ Task" ‚Üí Create tasks manually</p><p><strong>Step 3: Customize Tasks</strong><br>Click on any task row ‚Üí Update owner, deadline, description ‚Üí Save</p><p><strong>Step 4: Create First Backup</strong><br>Click Backup icon (üíæ) ‚Üí Download Backup ‚Üí Save to network drive or cloud storage</p><p><strong>Step 5: Bookmark</strong><br>Press Ctrl+D to bookmark this page for easy daily access</p></div></div><div><h4 class="font-semibold text-lg mb-2">üíæ Backup Instructions (CRITICAL)</h4><div class="bg-red-50 border-l-4 border-red-500 p-4 text-sm space-y-3"><p class="font-bold text-red-900">You WILL Lose Data If:</p><ul class="list-disc list-inside text-red-800 space-y-1"><li>Browser cache/data is cleared</li><li>You switch browsers (Chrome ‚Üí Firefox)</li><li>You switch computers (work ‚Üí home)</li><li>Computer crashes or hard drive fails</li><li>You use incognito/private browsing mode</li></ul><p class="font-bold text-red-900 mt-3">Weekly Backup Process:</p><ol class="list-decimal list-inside text-red-800 space-y-1"><li>Click Backup icon (üíæ at top)</li><li>Click "Download Backup"</li><li>Save JSON file to: Network drive, OneDrive, Google Drive, or email to yourself</li><li>Name it with date: STUDY-ID_backup_2025-01-26.json</li><li>Keep multiple dated backups (don\'t overwrite)</li></ol><p class="font-bold text-red-900 mt-3">To Restore Data:</p><ol class="list-decimal list-inside text-red-800 space-y-1"><li>Click Backup icon (üíæ)</li><li>Click "Restore from Backup"</li><li>Select your JSON backup file</li><li>All data is restored!</li></ol></div></div><div><h4 class="font-semibold text-lg mb-2">üìä Understanding Metrics</h4><div class="text-sm space-y-3"><p><strong>Automatic Calculations (Update Instantly):</strong></p><ul class="list-disc list-inside text-gray-700 ml-4 space-y-1"><li><strong>Overall Progress:</strong> (Completed Tasks √∑ Total Tasks) √ó 100</li><li><strong>Days Since LPFV:</strong> Today - LPFV Date (uses Actual if entered, otherwise Forecast)</li><li><strong>Days to DB Lock:</strong> DB Lock Date - Today (uses Actual if entered, otherwise Forecast)</li><li><strong>Days to Final Report:</strong> Final Report Date - Today</li><li><strong>Progress by Category:</strong> Completion percentage per category</li><li><strong>Smart Status Counts:</strong> Number of tasks that are Blocked, Ready, In Progress, Completed</li></ul><p class="mt-3"><strong>Manual Updates Required (in Settings):</strong></p><ul class="list-disc list-inside text-gray-700 ml-4 space-y-1"><li><strong>Outstanding Queries:</strong> Check your EDC/query management system, enter the number</li><li><strong>eTMF Completeness:</strong> Check your eTMF platform, enter the percentage</li><li><strong>Inspection Readiness:</strong> Your internal assessment, enter percentage</li></ul><p class="mt-3 text-gray-600"><em>Update these weekly or as needed. Click Settings icon ‚Üí Compliance section.</em></p></div></div><div><h4 class="font-semibold text-lg mb-2">üéØ Smart Status System Explained</h4><p class="text-sm text-gray-700 mb-3">Every task automatically shows an intelligent status based on dependencies:</p><div class="space-y-2 text-sm"><div class="flex items-center gap-3"><span class="text-2xl">üî¥</span><div><strong>Blocked</strong> - Dependencies not completed yet. Cannot start until prerequisite tasks are done.</div></div><div class="flex items-center gap-3"><span class="text-2xl">üü°</span><div><strong>Ready</strong> - All dependencies met! You can start this task now.</div></div><div class="flex items-center gap-3"><span class="text-2xl">üîµ</span><div><strong>In Progress</strong> - Currently working on this task.</div></div><div class="flex items-center gap-3"><span class="text-2xl">üü¢</span><div><strong>Completed</strong> - Task is done.</div></div></div><p class="text-sm text-gray-600 mt-3"><em>Smart Status updates automatically as you complete tasks and their dependencies.</em></p></div><div><h4 class="font-semibold text-lg mb-2">üìã Using Templates</h4><div class="text-sm space-y-2"><p><strong>To Load a Template:</strong></p><ol class="list-decimal list-inside text-gray-700 space-y-1"><li>Click Templates icon (üìã)</li><li>Select from: Study Manager Close-Out, Verification Activities, or IND Termination</li><li>Confirm replacement (this replaces all current tasks)</li><li>Tasks load with pre-configured dependencies</li><li>Customize owners and deadlines for your trial</li></ol><p class="mt-3"><strong>To Create Custom Template:</strong></p><ol class="list-decimal list-inside text-gray-700 space-y-1"><li>Click Templates icon ‚Üí "Manage Templates"</li><li>Click "Create New Template"</li><li>Enter template name and description</li><li>Click "Next: Add Tasks"</li><li>Add tasks one by one with "+ Add Task"</li><li>For each task: set name, category, role, priority, and dependencies</li><li>Dependencies use task numbers (#1, #2, etc.)</li><li>Click "Done" when finished</li></ol><p class="mt-3"><strong>To Edit Existing Template:</strong></p><ol class="list-decimal list-inside text-gray-700 space-y-1"><li>Click Templates icon ‚Üí "Manage Templates"</li><li>Find your template</li><li>Click ‚úèÔ∏è to edit name/description OR click "Tasks" to manage tasks</li><li>Add, edit, or delete tasks within the template</li><li>Changes save automatically</li></ol></div></div><div><h4 class="font-semibold text-lg mb-2">üìä View Options</h4><ul class="list-disc list-inside text-sm text-gray-700 space-y-1"><li><strong>Table View (Default):</strong> Traditional task list with all details in columns</li><li><strong>Workflow View:</strong> Click "üîÄ Workflow" button - Visual flowchart showing task sequence and dependencies</li><li><strong>Timeline View:</strong> Click "üìÖ Timeline" button - Gantt-style view sorted by deadline</li></ul></div><div><h4 class="font-semibold text-lg mb-2">‚ö° Critical Path & Task Prioritization</h4><p class="text-sm text-gray-700 mb-2">The dashboard automatically identifies:</p><ul class="list-disc list-inside text-sm text-gray-700 space-y-1"><li><strong>Critical Path Tasks:</strong> Red alert banner shows tasks that are blocking other tasks. These should be your top priority!</li><li><strong>Ready to Start:</strong> Green section shows tasks where all dependencies are met - work on these next</li><li><strong>Blocked Tasks:</strong> Red section shows tasks waiting on dependencies - these cannot start yet</li></ul><p class="text-sm text-gray-600 mt-2"><em>Focus on Critical Path and Ready tasks to keep your closeout on track.</em></p></div><div><h4 class="font-semibold text-lg mb-2">üìÅ Managing Features</h4><div class="text-sm space-y-3"><p><strong>Add Task:</strong> Click "+ Task" icon ‚Üí Fill in all fields ‚Üí Select dependencies (Ctrl+Click for multiple) ‚Üí Save</p><p><strong>Edit Task:</strong> Click anywhere on the task row in table ‚Üí Update any fields ‚Üí Save</p><p><strong>Delete Task:</strong> Click on task row ‚Üí Scroll to bottom ‚Üí Delete button</p><p><strong>Remove Dependencies:</strong> When editing task ‚Üí In Dependencies dropdown, click selected items to deselect them ‚Üí Save</p><p><strong>Sort Tasks:</strong> Use "Sort by" dropdown - Deadline, Name, Priority, Status</p><p><strong>Filter Tasks:</strong> Use "Filter by" dropdowns - Category, Priority, Smart Status</p><p><strong>Add Document:</strong> Click Documents icon (üìÑ) ‚Üí Add Document ‚Üí Enter details ‚Üí Optionally attach file ‚Üí Save</p><p><strong>Download Document:</strong> In Documents section ‚Üí Click ‚¨áÔ∏è on any attached file</p><p><strong>Update Settings:</strong> Click Settings icon (‚öôÔ∏è) ‚Üí Edit any field ‚Üí Save</p><p><strong>Manage Categories:</strong> Click Categories icon (üìÅ) ‚Üí Add, edit, or remove categories ‚Üí Save</p><p><strong>Export Reports:</strong> Click Export icon (üì§) ‚Üí Choose Excel, PDF, or Word format</p></div></div><div><h4 class="font-semibold text-lg mb-2">üîß Troubleshooting Common Issues</h4><div class="text-sm space-y-3"><div><p class="font-medium text-gray-800">Problem: My data disappeared</p><p class="text-gray-600 ml-4">‚Üí Possible causes: Using different browser, different computer, or browser data was cleared<br>‚Üí Solution: Restore from your JSON backup file. This is why weekly backups are critical!</p></div><div><p class="font-medium text-gray-800">Problem: Changes not saving</p><p class="text-gray-600 ml-4">‚Üí Check if "Auto-saved" message appears after making changes<br>‚Üí Don\'t use incognito/private browsing mode<br>‚Üí Check browser localStorage is not full</p></div><div><p class="font-medium text-gray-800">Problem: Can\'t see dashboard updates from administrator</p><p class="text-gray-600 ml-4">‚Üí Press Ctrl+Shift+R (hard refresh) to clear cache<br>‚Üí Wait 2-3 minutes after administrator updates<br>‚Üí Try opening in incognito window to test</p></div><div><p class="font-medium text-gray-800">Problem: Task shows as Blocked but shouldn\'t be</p><p class="text-gray-600 ml-4">‚Üí Click on the task to edit it<br>‚Üí In Dependencies dropdown, click the selected items to deselect them<br>‚Üí Save - task will now show as Ready</p></div><div><p class="font-medium text-gray-800">Problem: Can\'t remove a dependency</p><p class="text-gray-600 ml-4">‚Üí In the Dependencies multi-select box, click on highlighted/selected items to deselect them<br>‚Üí Or press Ctrl+Click on selected items to remove them<br>‚Üí Save the task</p></div><div><p class="font-medium text-gray-800">Problem: Export not working</p><p class="text-gray-600 ml-4">‚Üí Check if browser pop-up blocker is preventing download<br>‚Üí Allow pop-ups for this site<br>‚Üí Try a different browser</p></div></div></div><div><h4 class="font-semibold text-lg mb-2">‚úÖ Best Practices</h4><div class="grid grid-cols-2 gap-4 text-sm"><div><p class="font-medium text-green-700 mb-2">DO:</p><ul class="list-disc list-inside text-gray-700 space-y-1"><li>Bookmark this page (Ctrl+D)</li><li>Use same browser always</li><li>Create weekly backups</li><li>Save backups to network drive or cloud (OneDrive, Google Drive)</li><li>Add task descriptions and comments as you work</li><li>Update compliance metrics weekly</li><li>Use templates to save time</li><li>Check Critical Path section daily</li><li>Focus on Ready tasks</li></ul></div><div><p class="font-medium text-red-700 mb-2">DON\'T:</p><ul class="list-disc list-inside text-gray-700 space-y-1"><li>Switch browsers (each has separate data)</li><li>Use incognito/private mode (data won\'t save)</li><li>Clear browser data without backup first</li><li>Assume data is "in the cloud"</li><li>Forget to backup before major changes</li><li>Work on multiple devices without backups</li><li>Share your backup files with unauthorized people</li></ul></div></div></div><div><h4 class="font-semibold text-lg mb-2">üìÖ Recommended Schedule</h4><div class="text-sm"><p><strong>Daily:</strong> Update task statuses and progress, check Ready tasks, review Critical Path</p><p><strong>Weekly:</strong> Download JSON backup to network drive, update compliance metrics from source systems</p><p><strong>Monthly:</strong> Export to Excel/PDF for stakeholder reports, verify all backups are accessible</p><p><strong>After Milestones:</strong> Create special backup after LPFV, DBL, CSR completion</p></div></div><div><h4 class="font-semibold text-lg mb-2">üîÑ Working with Multiple Trials</h4><div class="text-sm space-y-2"><p><strong>Method 1: One Trial at a Time</strong></p><ol class="list-decimal list-inside text-gray-700"><li>Export current trial data to JSON</li><li>Save with clear name: STUDY-A_backup.json</li><li>Click Settings ‚Üí Change to new trial details</li><li>Load new template or enter new tasks</li><li>To switch back: Import STUDY-A_backup.json</li></ol><p class="mt-3"><strong>Method 2: Use Different Browsers</strong></p><ul class="list-disc list-inside text-gray-700"><li>Chrome for Trial A</li><li>Firefox for Trial B</li><li>Edge for Trial C</li><li>Each browser stores completely separate data</li></ul></div></div><div><h4 class="font-semibold text-lg mb-2">üéì Understanding Dependencies</h4><div class="text-sm text-gray-700 space-y-2"><p>Dependencies define which tasks must be completed before others can start.</p><p><strong>How to Set Dependencies:</strong></p><ul class="list-disc list-inside ml-4"><li>When adding/editing a task, use the Dependencies dropdown</li><li>Hold Ctrl (Windows) or Cmd (Mac) to select multiple tasks</li><li>Selected tasks MUST be completed before this task can start</li></ul><p><strong>How to Remove Dependencies:</strong></p><ul class="list-disc list-inside ml-4"><li>Click on task to edit it</li><li>In Dependencies dropdown, click highlighted items to deselect them</li><li>Or Ctrl+Click on selected items</li><li>Save - task will no longer be blocked by those dependencies</li></ul><p><strong>Example Workflow:</strong></p><ul class="list-disc list-inside ml-4"><li>Task: "Database Lock" depends on "Close Open Actions"</li><li>Task: "CSR" depends on "Database Lock" AND "Statistical Analysis"</li><li>Until dependencies are marked Complete, dependent tasks show as Blocked (üî¥)</li></ul></div></div><div><h4 class="font-semibold text-lg mb-2">üì§ Export Options</h4><div class="text-sm space-y-2"><p><strong>Excel:</strong> Full data table with all task details, smart status, dependencies. Best for analysis and sharing with team.</p><p><strong>PDF:</strong> Formatted document showing task list. Best for printing or formal distribution.</p><p><strong>Word:</strong> Editable document with task table. Best for adding to reports or presentations.</p><p><strong>JSON Backup:</strong> Complete data backup. Best for restoring your dashboard later. This is your safety net!</p><p class="text-gray-600 italic mt-2">Use Export for sharing, use Backup for safety!</p></div></div><div class="bg-yellow-50 border-l-4 border-yellow-500 p-4"><h4 class="font-bold text-yellow-900 mb-2">üîí Data Privacy & Security</h4><p class="text-sm text-yellow-800 mb-2">Your trial data is completely private:</p><ul class="list-disc list-inside text-sm text-yellow-800 space-y-1"><li>Stored ONLY on your computer\'s browser (localStorage)</li><li>Never uploaded to any server or cloud</li><li>Not shared with other users</li><li>Not visible to dashboard administrator</li><li>Not accessible by anyone else</li></ul><p class="text-sm text-yellow-800 mt-2"><strong>Important:</strong> If using shared computer, other users of same browser can access your data. Use your own device or clear data when done.</p></div><div><h4 class="font-semibold text-lg mb-2">üÜò Emergency Procedures</h4><div class="text-sm space-y-2"><p><strong>If Dashboard Link Stops Working:</strong></p><ol class="list-decimal list-inside text-gray-700"><li>Don\'t panic - your data is safe on your computer</li><li>Contact administrator for new link</li><li>Use your JSON backup to view data (open with text editor)</li><li>When new link is available, restore from backup</li></ol><p class="mt-3"><strong>If You Accidentally Delete Data:</strong></p><ol class="list-decimal list-inside text-gray-700"><li>Immediately stop making changes</li><li>Don\'t close the browser (data might still be recoverable)</li><li>Restore from your most recent JSON backup</li><li>Re-enter any changes made since that backup</li></ol></div></div><div><h4 class="font-semibold text-lg mb-2">üí° Pro Tips</h4><ul class="list-disc list-inside text-sm text-gray-700 space-y-1"><li>Set a Friday calendar reminder to create weekly backups</li><li>Keep at least 3-4 dated backups (don\'t keep just one)</li><li>Use task descriptions to track progress notes and issues</li><li>Review Critical Path section daily to avoid bottlenecks</li><li>Use Workflow View to understand task sequence</li><li>Use Timeline View to see deadline distribution</li><li>Export to Excel weekly for team status meetings</li><li>Create templates for your common workflows to save time</li><li>Name your backups with dates for easy identification</li></ul></div><div><h4 class="font-semibold text-lg mb-2">üìû Getting Help</h4><p class="text-sm text-gray-700">For technical issues, access problems, or questions, contact your dashboard administrator.</p><p class="text-sm text-gray-700 mt-2">Before contacting support, try: Hard refresh (Ctrl+Shift+R), clear cache, check if you have a backup, try incognito mode.</p></div></div><button onclick="this.closest(\'.fixed\').remove()" class="mt-6 w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Close Help</button></div>';
            } else if (type === 'workflow') {
                const tasks = studyData.closeoutTasks;
                content = '<div class="bg-white rounded-lg p-6 max-w-6xl w-full max-h-screen overflow-y-auto"><h3 class="text-xl font-bold mb-4">üîÄ Workflow View</h3><div class="bg-gray-50 p-6 rounded overflow-x-auto"><div style="min-width: 800px">' + (tasks.length === 0 ? '<p class="text-center text-gray-500 py-8">No tasks</p>' : tasks.map(task => {
                    const smartStatus = getTaskStatus(task);
                    const deps = task.dependencies.map(id => tasks.find(t => t.id === id)?.name || 'Unknown');
                    return '<div class="mb-4 flex items-center gap-3"><div class="flex-shrink-0 w-8 text-2xl">' + getStatusIcon(smartStatus) + '</div><div class="flex-1 border rounded-lg p-3 ' + getStatusColor(smartStatus) + '"><div class="font-medium">' + task.name + '</div><div class="text-xs mt-1">' + task.category + ' | ' + (task.owner || 'Unassigned') + ' | ' + task.deadline + '</div>' + (deps.length > 0 ? '<div class="text-xs mt-1 text-gray-600">‚Ü≥ Depends on: ' + deps.join(', ') + '</div>' : '') + '</div></div>';
                }).join('')) + '</div></div><button onclick="this.closest(\'.fixed\').remove()" class="mt-4 w-full px-4 py-2 border rounded-md">Close</button></div>';
            } else if (type === 'timeline') {
                const sorted = [...studyData.closeoutTasks].sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
                content = '<div class="bg-white rounded-lg p-6 max-w-6xl w-full max-h-screen overflow-y-auto"><h3 class="text-xl font-bold mb-4">üìÖ Timeline</h3><div class="bg-gray-50 p-6 rounded overflow-x-auto">' + (sorted.length === 0 ? '<p class="text-center text-gray-500 py-8">No tasks</p>' : sorted.map(task => {
                    const smartStatus = getTaskStatus(task);
                    const daysTo = task.deadline ? -calculateDays(task.deadline) : null;
                    return '<div class="mb-3 flex items-center gap-3"><div class="w-24 text-sm text-gray-600">' + task.deadline + '</div><div class="flex-1"><div class="flex items-center gap-2"><div class="text-lg">' + getStatusIcon(smartStatus) + '</div><div class="flex-1 border-l-4 ' + (smartStatus === 'blocked' ? 'border-red-500' : smartStatus === 'ready' ? 'border-yellow-500' : smartStatus === 'inprogress' ? 'border-blue-500' : 'border-green-500') + ' pl-3"><div class="font-medium">' + task.name + '</div><div class="text-xs text-gray-600">' + task.category + '</div></div><div class="text-sm text-gray-600">' + (daysTo !== null ? (daysTo > 0 ? daysTo + ' days' : Math.abs(daysTo) + ' days ago') : '') + '</div></div></div></div>';
                }).join('')) + '</div><button onclick="this.closest(\'.fixed\').remove()" class="mt-4 w-full px-4 py-2 border rounded-md">Close</button></div>';
            } else if (type === 'export') {
                content = '<div class="bg-white rounded-lg p-6 max-w-lg w-full"><h3 class="text-xl font-bold mb-4">Export</h3><div class="space-y-3"><button onclick="exportToExcel()" class="w-full px-4 py-3 bg-green-50 hover:bg-green-100 border rounded-md text-left"><div class="font-medium">üìä Excel</div></button><button onclick="exportToPDF()" class="w-full px-4 py-3 bg-red-50 hover:bg-red-100 border rounded-md text-left"><div class="font-medium">üìÑ PDF</div></button><button onclick="exportToWord()" class="w-full px-4 py-3 bg-blue-50 hover:bg-blue-100 border rounded-md text-left"><div class="font-medium">üìù Word</div></button></div><button onclick="this.closest(\'.fixed\').remove()" class="mt-4 w-full px-4 py-2 border rounded-md">Close</button></div>';
            } else if (type === 'backup') {
                content = '<div class="bg-white rounded-lg p-6 max-w-lg w-full"><h3 class="text-xl font-bold mb-4">Backup & Restore</h3><div class="space-y-3"><button onclick="exportJSON()" class="w-full px-4 py-3 bg-blue-50 hover:bg-blue-100 border rounded-md text-left"><div class="font-medium">üíæ Download Backup</div></button><button onclick="importJSON()" class="w-full px-4 py-3 bg-purple-50 hover:bg-purple-100 border rounded-md text-left"><div class="font-medium">üìÇ Restore</div></button></div><button onclick="this.closest(\'.fixed\').remove()" class="mt-4 w-full px-4 py-2 border rounded-md">Close</button></div>';
            } else if (type === 'documents') {
                content = '<div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-screen overflow-y-auto"><h3 class="text-xl font-bold mb-4">Documents</h3><div class="mb-4"><button onclick="addDocument()" class="px-4 py-2 bg-green-600 text-white rounded-md">+ Add</button></div><div class="space-y-2">' + ((studyData.documents || []).length === 0 ? '<p class="text-gray-500 text-center py-8">No documents</p>' : studyData.documents.map((doc, idx) => '<div class="border rounded p-4 hover:bg-gray-50"><div class="flex justify-between"><div class="flex-1"><h4 class="font-medium">' + doc.name + '</h4>' + (doc.description ? '<p class="text-sm text-gray-600">' + doc.description + '</p>' : '') + '<div class="flex gap-3 mt-1 text-xs text-gray-500"><span>' + doc.type + '</span><span>' + doc.category + '</span><span>v' + doc.version + '</span>' + (doc.fileSize ? '<span>' + doc.fileSize + '</span>' : '') + '</div></div><div class="flex gap-2">' + (doc.fileData ? '<button onclick="downloadDocument(' + idx + ')" class="text-blue-600">‚¨áÔ∏è</button>' : '') + '<button onclick="editDocument(' + idx + ')" class="text-green-600">‚úèÔ∏è</button><button onclick="deleteDocument(' + idx + ')" class="text-red-600">üóëÔ∏è</button></div></div></div>').join('')) + '</div><button onclick="this.closest(\'.fixed\').remove()" class="mt-4 w-full px-4 py-2 border rounded-md">Close</button></div>';
            } else if (type === 'document-form') {
                const isEdit = window.editingDocIndex !== undefined;
                const doc = isEdit ? studyData.documents[window.editingDocIndex] : { name: '', description: '', type: 'Protocol', category: studyData.categories[0], version: '1.0' };
                content = '<div class="bg-white rounded-lg p-6 max-w-2xl w-full"><h3 class="text-xl font-bold mb-4">' + (isEdit ? 'Edit' : 'Add') + ' Document</h3><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Name *</label><input type="text" id="docName" value="' + doc.name + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Description</label><textarea id="docDescription" class="w-full px-3 py-2 border rounded-md" rows="3">' + (doc.description || '') + '</textarea></div><div class="grid grid-cols-3 gap-4"><div><label class="block text-sm font-medium mb-1">Type</label><select id="docType" class="w-full px-3 py-2 border rounded-md">' + ['Protocol', 'ICF', 'CSR', 'SAP', 'Report', 'Other'].map(t => '<option ' + (t === doc.type ? 'selected' : '') + '>' + t + '</option>').join('') + '</select></div><div><label class="block text-sm font-medium mb-1">Category</label><select id="docCategory" class="w-full px-3 py-2 border rounded-md">' + studyData.categories.map(c => '<option ' + (c === doc.category ? 'selected' : '') + '>' + c + '</option>').join('') + '</select></div><div><label class="block text-sm font-medium mb-1">Version</label><input type="text" id="docVersion" value="' + doc.version + '" class="w-full px-3 py-2 border rounded-md"></div></div><div class="border-t pt-4"><label class="block text-sm font-medium mb-2">üìé Attach File</label><input type="file" id="docFileInput" class="w-full px-3 py-2 border rounded-md text-sm">' + (doc.fileName ? '<p class="text-xs text-green-600 mt-2">‚úì ' + doc.fileName + ' (' + doc.fileSize + ')</p>' : '') + '</div></div><div class="flex justify-end gap-3 mt-6"><button onclick="this.closest(\'.fixed\').remove(); window.editingDocIndex = undefined;" class="px-4 py-2 border rounded-md">Cancel</button><button onclick="saveDocument()" class="px-4 py-2 bg-green-600 text-white rounded-md">Save</button></div></div>';
            } else if (type === 'categories') {
                content = '<div class="bg-white rounded-lg p-6 max-w-2xl w-full"><h3 class="text-xl font-bold mb-4">Categories</h3><div class="space-y-2 mb-4" id="categoryList">' + studyData.categories.map((cat, idx) => '<div class="flex gap-2"><input type="text" value="' + cat + '" class="flex-1 px-3 py-2 border rounded-md" id="cat_' + idx + '"><button onclick="removeCategory(' + idx + ')" class="px-3 py-2 bg-red-100 text-red-600 rounded-md">Remove</button></div>').join('') + '</div><button onclick="addCategory()" class="w-full px-4 py-2 bg-green-100 text-green-700 rounded-md mb-4">+ Add</button><div class="flex justify-end gap-3"><button onclick="this.closest(\'.fixed\').remove()" class="px-4 py-2 border rounded-md">Cancel</button><button onclick="saveCategories()" class="px-4 py-2 bg-blue-600 text-white rounded-md">Save</button></div></div>';
            } else if (type === 'settings') {
                content = '<div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-screen overflow-y-auto"><h3 class="text-xl font-bold mb-4">Settings</h3><div class="space-y-4"><div class="border-b pb-4 mb-4"><h4 class="font-semibold mb-3">üé® Appearance</h4><div><label class="block text-sm font-medium mb-2">Theme</label><div class="flex gap-3"><button onclick="toggleTheme(\'light\'); render();" class="px-4 py-2 rounded-md border ' + (studyData.theme === 'light' ? 'bg-blue-600 text-white' : 'bg-white') + '">‚òÄÔ∏è Light Mode</button><button onclick="toggleTheme(\'dark\'); render();" class="px-4 py-2 rounded-md border ' + (studyData.theme === 'dark' ? 'bg-blue-600 text-white' : 'bg-white') + '">üåô Dark Mode</button></div></div></div><div class="border-b pb-4 mb-4 bg-red-50 p-4 rounded-lg border border-red-200"><h4 class="font-semibold mb-3 text-red-800">üóëÔ∏è Danger Zone</h4><p class="text-sm text-red-700 mb-3">Clear all study data and start fresh. This will delete all tasks, documents, and settings but keep your templates.</p><button onclick="clearAllData()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 font-medium">Clear All Data</button></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Version</label><input type="text" id="version" value="' + studyData.version + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Study ID</label><input type="text" id="studyId" value="' + studyData.studyId + '" class="w-full px-3 py-2 border rounded-md"></div></div><div><label class="block text-sm font-medium mb-1">Study Name</label><input type="text" id="studyName" value="' + studyData.studyName + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Protocol</label><input type="text" id="protocolName" value="' + studyData.protocolName + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Trial Type</label><input type="text" id="trialType" value="' + studyData.trialType + '" class="w-full px-3 py-2 border rounded-md"></div><div class="border-t pt-4"><h4 class="font-semibold mb-3">Compliance</h4><div class="grid grid-cols-3 gap-4"><div><label class="block text-sm font-medium mb-1">Queries</label><input type="number" id="outstandingQueries" value="' + studyData.complianceMetrics.outstandingQueries + '" class="w-full px-3 py-2 border rounded-md" min="0"></div><div><label class="block text-sm font-medium mb-1">eTMF %</label><input type="number" id="etmfCompleteness" value="' + studyData.complianceMetrics.etmfCompleteness + '" class="w-full px-3 py-2 border rounded-md" min="0" max="100"></div><div><label class="block text-sm font-medium mb-1">Inspection %</label><input type="number" id="inspectionReadiness" value="' + studyData.complianceMetrics.inspectionReadiness + '" class="w-full px-3 py-2 border rounded-md" min="0" max="100"></div></div></div><div class="border-t pt-4"><h4 class="font-semibold mb-3">LPFV</h4><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Forecast</label><input type="date" id="lpfvDateForecasted" value="' + (studyData.lpfvDateForecasted || '') + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Actual</label><input type="date" id="lpfvDateActual" value="' + (studyData.lpfvDateActual || '') + '" class="w-full px-3 py-2 border rounded-md"></div></div></div><div class="border-t pt-4"><h4 class="font-semibold mb-3">DB Lock</h4><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Forecast</label><input type="date" id="targetDbLockForecasted" value="' + (studyData.targetDbLockForecasted || '') + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Actual</label><input type="date" id="targetDbLockActual" value="' + (studyData.targetDbLockActual || '') + '" class="w-full px-3 py-2 border rounded-md"></div></div></div><div class="border-t pt-4"><h4 class="font-semibold mb-3">Final Report</h4><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Forecast</label><input type="date" id="finalReportForecasted" value="' + (studyData.finalReportForecasted || '') + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Actual</label><input type="date" id="finalReportActual" value="' + (studyData.finalReportActual || '') + '" class="w-full px-3 py-2 border rounded-md"></div></div></div></div><div class="flex justify-end gap-3 mt-6"><button onclick="this.closest(\'.fixed\').remove()" class="px-4 py-2 border rounded-md">Cancel</button><button onclick="saveSettings()" class="px-4 py-2 bg-blue-600 text-white rounded-md">Save</button></div></div>';
            } else if (type === 'task') {
                const isEdit = window.editingTask;
                const task = isEdit || { name: '', description: '', category: studyData.categories[0], owner: '', role: '', deadline: '', status: 'Not Started', priority: 'Medium', progress: 0, dependencies: [], links: [], instructions: '' };
                // Convert old single link to array format for backwards compatibility
                if (!task.links && task.link) task.links = [{name: 'Link', url: task.link}];
                if (!task.links) task.links = [];
                
                content = '<div class="bg-white rounded-lg p-6 max-w-3xl w-full max-h-screen overflow-y-auto"><h3 class="text-xl font-bold mb-4">' + (isEdit ? 'Edit' : 'Add') + ' Task</h3><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Name *</label><input type="text" id="taskName" value="' + task.name + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Description</label><textarea id="taskDescription" class="w-full px-3 py-2 border rounded-md" rows="2">' + (task.description || '') + '</textarea></div><div><label class="block text-sm font-medium mb-1">Instructions</label><textarea id="taskInstructions" class="w-full px-3 py-2 border rounded-md" rows="3" placeholder="Step-by-step instructions or guidance for completing this task...">' + (task.instructions || '') + '</textarea></div><div><label class="block text-sm font-medium mb-2">Links</label><div id="linksContainer" class="space-y-2 mb-3">' + (task.links.length > 0 ? task.links.map((link, idx) => '<div class="flex items-center gap-2 p-3 bg-blue-50 border border-blue-200 rounded"><a href="' + link.url + '" target="_blank" rel="noopener noreferrer" class="flex-1 text-blue-600 hover:text-blue-800 font-medium flex items-center gap-2"><svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg><span>' + link.name + '</span></a><button onclick="removeTaskLink(' + idx + ')" class="px-2 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 text-xs font-medium">Remove</button></div>').join('') : '<p class="text-sm text-gray-500 italic">No links added</p>') + '</div><div class="border-t pt-3"><p class="text-xs text-gray-600 mb-2">Add a new link:</p><div class="space-y-2"><input type="text" id="newLinkName" placeholder="Link name (e.g., Quality Docs, eTMF System)" class="w-full px-3 py-2 border rounded-md text-sm"><input type="url" id="newLinkUrl" placeholder="https://example.com/resource" class="w-full px-3 py-2 border rounded-md text-sm"><button onclick="addTaskLink()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">+ Add Link</button></div></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Category</label><select id="taskCategory" class="w-full px-3 py-2 border rounded-md">' + studyData.categories.map(c => '<option ' + (c === task.category ? 'selected' : '') + '>' + c + '</option>').join('') + '</select></div><div><label class="block text-sm font-medium mb-1">Priority</label><select id="taskPriority" class="w-full px-3 py-2 border rounded-md">' + ['Critical', 'High', 'Medium', 'Low'].map(p => '<option ' + (p === task.priority ? 'selected' : '') + '>' + p + '</option>').join('') + '</select></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Role *</label><input type="text" id="taskRole" value="' + task.role + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Owner *</label><input type="text" id="taskOwner" value="' + task.owner + '" class="w-full px-3 py-2 border rounded-md"></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Deadline *</label><input type="date" id="taskDeadline" value="' + task.deadline + '" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Status</label><select id="taskStatus" class="w-full px-3 py-2 border rounded-md">' + ['Not Started', 'In Progress', 'Completed'].map(s => '<option ' + (s === task.status ? 'selected' : '') + '>' + s + '</option>').join('') + '</select></div></div><div><label class="block text-sm font-medium mb-1">Progress %</label><input type="number" id="taskProgress" value="' + task.progress + '" min="0" max="100" class="w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium mb-1">Dependencies</label><select id="taskDependencies" multiple class="w-full px-3 py-2 border rounded-md" style="height: 100px">' + studyData.closeoutTasks.filter(t => !isEdit || t.id !== task.id).map(t => '<option value="' + t.id + '" ' + (task.dependencies && task.dependencies.includes(t.id) ? 'selected' : '') + '>' + t.name + '</option>').join('') + '</select><p class="text-xs text-gray-500">Hold Ctrl/Cmd for multiple. Click selected items to deselect and remove dependencies.</p></div></div><div class="flex justify-between items-center gap-3 mt-6 pt-4 border-t">' + (isEdit ? '<button onclick="deleteTaskFromEdit(' + task.id + ')" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Delete Task</button>' : '<div></div>') + '<div class="flex gap-3"><button onclick="this.closest(\'.fixed\').remove(); window.editingTask = null;" class="px-4 py-2 border rounded-md">Cancel</button><button onclick="saveTask()" class="px-4 py-2 bg-green-600 text-white rounded-md">Save</button></div></div></div>';
                
                // Store current task for link management
                window.currentTaskLinks = task.links || [];
            }

            overlay.innerHTML = content;
            document.body.appendChild(overlay);
        }

        function addDocument() { window.editingDocIndex = undefined; showModal('document-form'); }
        function editDocument(idx) { window.editingDocIndex = idx; showModal('document-form'); }
        function deleteDocument(idx) { if (confirm('Delete?')) { studyData.documents.splice(idx, 1); saveData(); document.querySelector('.fixed').remove(); showModal('documents'); } }
        
        function saveDocument() {
            const name = document.getElementById('docName').value;
            if (!name) { alert('Name required'); return; }
            const fileInput = document.getElementById('docFileInput');
            const doc = studyData.documents && window.editingDocIndex !== undefined ? {...studyData.documents[window.editingDocIndex]} : {};
            doc.name = name; doc.description = document.getElementById('docDescription').value;
            doc.type = document.getElementById('docType').value; doc.category = document.getElementById('docCategory').value;
            doc.version = document.getElementById('docVersion').value;
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    doc.fileName = file.name; doc.fileSize = (file.size / 1024).toFixed(2) + ' KB';
                    doc.uploadDate = new Date().toISOString().split('T')[0]; doc.fileData = e.target.result;
                    if (!studyData.documents) studyData.documents = [];
                    if (window.editingDocIndex !== undefined) studyData.documents[window.editingDocIndex] = doc;
                    else studyData.documents.push(doc);
                    saveData(); window.editingDocIndex = undefined;
                    document.querySelector('.fixed').remove(); showModal('documents');
                };
                reader.readAsDataURL(file);
            } else {
                if (!studyData.documents) studyData.documents = [];
                if (window.editingDocIndex !== undefined) studyData.documents[window.editingDocIndex] = doc;
                else studyData.documents.push(doc);
                saveData(); window.editingDocIndex = undefined;
                document.querySelector('.fixed').remove(); showModal('documents');
            }
        }

        function downloadDocument(idx) {
            const doc = studyData.documents[idx];
            if (!doc.fileData) { alert('No file'); return; }
            const link = document.createElement('a');
            link.href = doc.fileData; link.download = doc.fileName; link.click();
        }

        function addCategory() {
            const list = document.getElementById('categoryList');
            const div = document.createElement('div'); div.className = 'flex gap-2';
            div.innerHTML = '<input type="text" class="flex-1 px-3 py-2 border rounded-md" id="cat_' + studyData.categories.length + '"><button onclick="this.parentElement.remove()" class="px-3 py-2 bg-red-100 text-red-600 rounded-md">Remove</button>';
            list.appendChild(div);
        }

        function removeCategory(idx) {
            const cat = studyData.categories[idx];
            if (studyData.closeoutTasks.some(t => t.category === cat)) { alert('In use'); return; }
            document.getElementById('cat_' + idx).parentElement.remove();
        }

        function saveCategories() {
            const newCats = Array.from(document.querySelectorAll('[id^="cat_"]')).map(inp => inp.value.trim()).filter(v => v);
            if (newCats.length === 0) { alert('Need 1+'); return; }
            studyData.categories = newCats; saveData(); render(); document.querySelector('.fixed').remove();
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL your study data including:\n\n‚Ä¢ All tasks\n‚Ä¢ All documents  \n‚Ä¢ All study information\n‚Ä¢ All dates and metrics\n\nYour templates will be preserved.\n\nThis action CANNOT be undone!\n\nAre you sure you want to continue?')) {
                return;
            }
            
            // Second confirmation
            if (!confirm('Final confirmation: Delete all data and start fresh?')) {
                return;
            }
            
            // Preserve templates and theme
            const preservedTemplates = studyData.templates;
            const preservedTheme = studyData.theme;
            
            // Reset to initial data
            studyData = {
                version: "8.0",
                studyId: "STUDY-1234-001",
                studyName: "Enter Your Study Name",
                protocolName: "PROTO-ABC-001",
                trialType: "Interventional",
                lpfvDateForecasted: "",
                lpfvDateActual: "",
                targetDbLockForecasted: "",
                targetDbLockActual: "",
                finalReportForecasted: "",
                finalReportActual: "",
                closeoutTasks: [],
                categories: ["Data Management", "Safety", "Quality", "Biostatistics", "Regulatory", "Documentation", "Finance", "Site Management", "Communication"],
                complianceMetrics: { outstandingQueries: 0, etmfCompleteness: 0, inspectionReadiness: 0 },
                documents: [],
                templates: preservedTemplates,
                loadedTemplate: null,
                currentView: 'table',
                searchQuery: '',
                theme: preservedTheme
            };
            
            window.searchQuery = '';
            window.currentFilter = { category: '', priority: '', status: '' };
            window.currentSort = 'deadline';
            
            saveData();
            applyTheme();
            render();
            
            document.querySelector('.fixed').remove();
            alert('‚úÖ All data cleared successfully!\n\nYou can now load a template to start fresh.');
        }

        function saveSettings() {
            studyData.version = document.getElementById('version').value;
            studyData.studyId = document.getElementById('studyId').value;
            studyData.studyName = document.getElementById('studyName').value;
            studyData.protocolName = document.getElementById('protocolName').value;
            studyData.trialType = document.getElementById('trialType').value;
            studyData.lpfvDateForecasted = document.getElementById('lpfvDateForecasted').value;
            studyData.lpfvDateActual = document.getElementById('lpfvDateActual').value;
            studyData.targetDbLockForecasted = document.getElementById('targetDbLockForecasted').value;
            studyData.targetDbLockActual = document.getElementById('targetDbLockActual').value;
            studyData.finalReportForecasted = document.getElementById('finalReportForecasted').value;
            studyData.finalReportActual = document.getElementById('finalReportActual').value;
            studyData.complianceMetrics.outstandingQueries = parseInt(document.getElementById('outstandingQueries').value) || 0;
            studyData.complianceMetrics.etmfCompleteness = parseInt(document.getElementById('etmfCompleteness').value) || 0;
            studyData.complianceMetrics.inspectionReadiness = parseInt(document.getElementById('inspectionReadiness').value) || 0;
            saveData(); render(); document.querySelector('.fixed').remove();
        }

        function saveTask() {
            const name = document.getElementById('taskName').value;
            const role = document.getElementById('taskRole').value;
            const owner = document.getElementById('taskOwner').value;
            const deadline = document.getElementById('taskDeadline').value;
            if (!name || !role || !owner || !deadline) { alert('Fill required'); return; }
            
            const dependencies = Array.from(document.getElementById('taskDependencies').selectedOptions).map(opt => parseInt(opt.value));
            const newStatus = document.getElementById('taskStatus').value;
            
            if (newStatus === 'Completed' && dependencies.length > 0) {
                const incomplete = dependencies.filter(depId => {
                    const dep = studyData.closeoutTasks.find(t => t.id === depId);
                    return !dep || dep.status !== 'Completed';
                });
                if (incomplete.length > 0) {
                    const names = incomplete.map(id => studyData.closeoutTasks.find(t => t.id === id)?.name || 'Unknown').join(', ');
                    if (!confirm('‚ö†Ô∏è Dependencies incomplete: ' + names + '. Continue?')) return;
                }
            }
            
            const task = {
                id: window.editingTask ? window.editingTask.id : Math.max(0, ...studyData.closeoutTasks.map(t => t.id)) + 1,
                name, 
                description: document.getElementById('taskDescription').value,
                instructions: document.getElementById('taskInstructions').value,
                links: window.currentTaskLinks || [],
                documents: window.currentTaskDocuments || [],
                category: document.getElementById('taskCategory').value, 
                priority: document.getElementById('taskPriority').value,
                role, owner, deadline, status: newStatus,
                progress: parseInt(document.getElementById('taskProgress').value), 
                dependencies
            };
            if (window.editingTask) {
                const idx = studyData.closeoutTasks.findIndex(t => t.id === window.editingTask.id);
                studyData.closeoutTasks[idx] = task;
            } else studyData.closeoutTasks.push(task);
            saveData(); render(); document.querySelector('.fixed').remove(); window.editingTask = null;
        }

        function editTask(id) { window.editingTask = studyData.closeoutTasks.find(t => t.id === id); showModal('task'); }
        
        function addTaskLink() {
            const nameInput = document.getElementById('newLinkName');
            const urlInput = document.getElementById('newLinkUrl');
            const name = nameInput.value.trim();
            const url = urlInput.value.trim();
            
            if (!name) {
                alert('Please enter a link name (e.g., "Quality Docs", "eTMF System")');
                return;
            }
            if (!url) {
                alert('Please enter a URL');
                return;
            }
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                alert('URL must start with http:// or https://');
                return;
            }
            
            if (!window.currentTaskLinks) window.currentTaskLinks = [];
            window.currentTaskLinks.push({name: name, url: url});
            nameInput.value = '';
            urlInput.value = '';
            showModal('task'); // Refresh modal to show new link
        }
        
        function removeTaskLink(index) {
            if (!window.currentTaskLinks) window.currentTaskLinks = [];
            window.currentTaskLinks.splice(index, 1);
            showModal('task'); // Refresh modal to show updated list
        }
        
        function uploadTaskDocument() {
            const fileInput = document.getElementById('taskDocumentUpload');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select a file to upload');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                if (!window.currentTaskDocuments) window.currentTaskDocuments = [];
                window.currentTaskDocuments.push({
                    name: file.name,
                    size: (file.size / 1024).toFixed(2) + ' KB',
                    date: new Date().toLocaleDateString(),
                    data: e.target.result
                });
                showModal('task'); // Refresh modal to show new document
            };
            reader.readAsDataURL(file);
        }
        
        function downloadTaskDocument(index) {
            if (!window.currentTaskDocuments || !window.currentTaskDocuments[index]) return;
            const doc = window.currentTaskDocuments[index];
            const link = document.createElement('a');
            link.href = doc.data;
            link.download = doc.name;
            link.click();
        }
        
        function removeTaskDocument(index) {
            if (!window.currentTaskDocuments) window.currentTaskDocuments = [];
            window.currentTaskDocuments.splice(index, 1);
            showModal('task'); // Refresh modal to show updated list
        }
        
        function deleteTask(id) {
            if (confirm('Delete this task?')) {
                studyData.closeoutTasks = studyData.closeoutTasks.filter(t => t.id !== id);
                studyData.closeoutTasks.forEach(t => { t.dependencies = t.dependencies.filter(dep => dep !== id); });
                saveData(); render();
            }
        }

        function deleteTaskFromEdit(id) {
            if (confirm('Delete this task permanently?')) {
                studyData.closeoutTasks = studyData.closeoutTasks.filter(t => t.id !== id);
                studyData.closeoutTasks.forEach(t => { t.dependencies = t.dependencies.filter(dep => dep !== id); });
                saveData();
                document.querySelector('.fixed').remove();
                window.editingTask = null;
                render();
            }
        }

        function showCategoryDetails(categoryName) {
            showModal('category-details', categoryName);
        }

        function getCategoryProgress() {
            return studyData.categories.map(cat => {
                const tasks = studyData.closeoutTasks.filter(t => t.category === cat);
                const completed = tasks.filter(t => t.status === 'Completed').length;
                return { name: cat, completed, total: tasks.length, percentage: tasks.length > 0 ? Math.round((completed / tasks.length) * 100) : 0 };
            });
        }

        function sortTasks(tasks, sortBy) {
            const sorted = [...tasks];
            if (sortBy === 'name') sorted.sort((a, b) => a.name.localeCompare(b.name));
            else if (sortBy === 'deadline') sorted.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
            else if (sortBy === 'priority') { const prio = { 'Critical': 1, 'High': 2, 'Medium': 3, 'Low': 4 }; sorted.sort((a, b) => prio[a.priority] - prio[b.priority]); }
            else if (sortBy === 'status') { const stat = { 'blocked': 1, 'ready': 2, 'inprogress': 3, 'completed': 4 }; sorted.sort((a, b) => stat[getTaskStatus(a)] - stat[getTaskStatus(b)]); }
            else if (sortBy === 'progress') sorted.sort((a, b) => b.progress - a.progress);
            return sorted;
        }

        function render() {
            const lpfvF = calculateDays(studyData.lpfvDateForecasted);
            const lpfvA = calculateDays(studyData.lpfvDateActual);
            const dblF = studyData.targetDbLockForecasted ? -calculateDays(studyData.targetDbLockForecasted) : null;
            const dblA = studyData.targetDbLockActual ? -calculateDays(studyData.targetDbLockActual) : null;
            const frF = studyData.finalReportForecasted ? -calculateDays(studyData.finalReportForecasted) : null;
            const frA = studyData.finalReportActual ? -calculateDays(studyData.finalReportActual) : null;
            const completed = studyData.closeoutTasks.filter(t => t.status === 'Completed').length;
            const progress = studyData.closeoutTasks.length > 0 ? Math.round((completed / studyData.closeoutTasks.length) * 100) : 0;
            const filter = window.currentFilter || { category: '', priority: '', status: '' };
            const sort = window.currentSort || 'deadline';
            const searchQuery = window.searchQuery || '';
            
            let filtered = studyData.closeoutTasks.filter(t => {
                const matchesFilter = (!filter.category || t.category === filter.category) && 
                                     (!filter.priority || t.priority === filter.priority) && 
                                     (!filter.status || getTaskStatus(t) === filter.status);
                
                const matchesSearch = !searchQuery || 
                                     t.name.toLowerCase().includes(searchQuery) ||
                                     (t.description && t.description.toLowerCase().includes(searchQuery)) ||
                                     (t.owner && t.owner.toLowerCase().includes(searchQuery)) ||
                                     (t.role && t.role.toLowerCase().includes(searchQuery)) ||
                                     (t.link && t.link.toLowerCase().includes(searchQuery)) ||
                                     (t.instructions && t.instructions.toLowerCase().includes(searchQuery));
                
                return matchesFilter && matchesSearch;
            });
            filtered = sortTasks(filtered, sort);
            
            const categoryProgress = getCategoryProgress();
            const criticalPath = getCriticalPath();
            const readyTasks = getReadyTasks();
            const blockedTasks = getBlockedTasks();
            
            const statusCounts = {
                blocked: studyData.closeoutTasks.filter(t => getTaskStatus(t) === 'blocked').length,
                ready: studyData.closeoutTasks.filter(t => getTaskStatus(t) === 'ready').length,
                inprogress: studyData.closeoutTasks.filter(t => getTaskStatus(t) === 'inprogress').length,
                completed: studyData.closeoutTasks.filter(t => getTaskStatus(t) === 'completed').length
            };

            document.getElementById('app').innerHTML = '<div class="min-h-screen p-6"><div class="bg-white rounded-lg shadow border p-6 mb-6"><div class="flex justify-between items-start flex-wrap gap-4"><div><h1 class="text-3xl font-bold text-gray-800">' + studyData.studyName + '</h1><p class="text-gray-600 mt-1">ID: ' + studyData.studyId + ' | Protocol: ' + studyData.protocolName + ' | Type: ' + studyData.trialType + '</p><div class="flex items-center gap-3 mt-2"><p class="text-sm text-gray-500">Trial Close-Out Checklist</p><span id="save-status" class="text-xs text-green-600"></span></div></div><div class="flex gap-2 flex-wrap"><button onclick="showModal(\'help\')" class="px-3 py-2 bg-cyan-100 hover:bg-cyan-200 rounded-md text-sm">‚ùì</button><button onclick="showModal(\'templates\')" class="px-3 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded-md text-sm">üìã Templates</button><button onclick="showModal(\'export\')" class="px-3 py-2 bg-indigo-100 hover:bg-indigo-200 rounded-md text-sm">üì§</button><button onclick="showModal(\'backup\')" class="px-3 py-2 bg-purple-100 hover:bg-purple-200 rounded-md text-sm">üíæ</button><button onclick="showModal(\'documents\')" class="px-3 py-2 bg-orange-100 hover:bg-orange-200 rounded-md text-sm">üìÑ</button><button onclick="showModal(\'categories\')" class="px-3 py-2 bg-yellow-100 hover:bg-yellow-200 rounded-md text-sm">üìÅ</button><button onclick="showModal(\'settings\')" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-md text-sm">‚öôÔ∏è</button><button onclick="showModal(\'task\')" class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm">+ Task</button></div></div></div>' +
            
            (studyData.closeoutTasks.length > 0 ? '<div class="grid grid-cols-4 gap-4 mb-6"><div class="bg-white rounded-lg shadow border p-4"><div class="flex items-center justify-between mb-2"><h3 class="text-sm font-medium">üî¥ Blocked</h3><span class="text-2xl font-bold text-red-600">' + statusCounts.blocked + '</span></div><p class="text-xs text-gray-500">Dependencies not met</p></div><div class="bg-white rounded-lg shadow border p-4"><div class="flex items-center justify-between mb-2"><h3 class="text-sm font-medium">üü° Ready</h3><span class="text-2xl font-bold text-yellow-600">' + statusCounts.ready + '</span></div><p class="text-xs text-gray-500">Can start now</p></div><div class="bg-white rounded-lg shadow border p-4"><div class="flex items-center justify-between mb-2"><h3 class="text-sm font-medium">üîµ In Progress</h3><span class="text-2xl font-bold text-blue-600">' + statusCounts.inprogress + '</span></div><p class="text-xs text-gray-500">Working</p></div><div class="bg-white rounded-lg shadow border p-4"><div class="flex items-center justify-between mb-2"><h3 class="text-sm font-medium">üü¢ Completed</h3><span class="text-2xl font-bold text-green-600">' + statusCounts.completed + '</span></div><p class="text-xs text-gray-500">Done</p></div></div>' : '') +
            
            '<div class="grid grid-cols-3 gap-4 mb-6"><div class="bg-white rounded-lg shadow border p-4"><h3 class="text-xs font-medium text-gray-600 mb-2">Days Since LPFV</h3><div class="grid grid-cols-2 gap-2"><div><div class="text-sm text-gray-500">Forecast</div><div class="text-xl font-bold">' + (lpfvF !== null ? Math.abs(lpfvF) : 'N/A') + '</div><div class="text-xs text-gray-500">(' + formatDate(studyData.lpfvDateForecasted) + ')</div></div><div><div class="text-sm text-gray-500">Actual</div><div class="text-xl font-bold text-blue-600">' + (lpfvA !== null ? Math.abs(lpfvA) : 'N/A') + '</div><div class="text-xs text-gray-500">(' + formatDate(studyData.lpfvDateActual) + ')</div></div></div></div><div class="bg-white rounded-lg shadow border p-4"><h3 class="text-xs font-medium text-gray-600 mb-2">Days to DB Lock</h3><div class="grid grid-cols-2 gap-2"><div><div class="text-sm text-gray-500">Forecast</div><div class="text-xl font-bold ' + (dblF !== null && dblF < 30 ? 'text-red-600' : '') + '">' + (dblF !== null ? dblF : 'N/A') + '</div><div class="text-xs text-gray-500">(' + formatDate(studyData.targetDbLockForecasted) + ')</div></div><div><div class="text-sm text-gray-500">Actual</div><div class="text-xl font-bold text-blue-600">' + (dblA !== null ? dblA : 'N/A') + '</div><div class="text-xs text-gray-500">(' + formatDate(studyData.targetDbLockActual) + ')</div></div></div></div><div class="bg-white rounded-lg shadow border p-4"><h3 class="text-xs font-medium text-gray-600 mb-2">Days to Final Report</h3><div class="grid grid-cols-2 gap-2"><div><div class="text-sm text-gray-500">Forecast</div><div class="text-xl font-bold">' + (frF !== null ? frF : 'N/A') + '</div><div class="text-xs text-gray-500">(' + formatDate(studyData.finalReportForecasted) + ')</div></div><div><div class="text-sm text-gray-500">Actual</div><div class="text-xl font-bold text-blue-600">' + (frA !== null ? frA : 'N/A') + '</div><div class="text-xs text-gray-500">(' + formatDate(studyData.finalReportActual) + ')</div></div></div></div></div>' +
            
            (criticalPath.length > 0 ? '<div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6"><h3 class="font-semibold text-red-900 mb-2">‚ö†Ô∏è Critical Path - ' + criticalPath.length + ' Blocking Task(s)</h3><div class="grid grid-cols-2 gap-3 max-h-52 overflow-y-auto pr-2">' + criticalPath.map(task => '<div class="bg-white rounded p-3 border border-red-200 cursor-pointer hover:bg-red-50 transition-colors" onclick="editTask(' + task.id + ')"><div class="font-medium text-sm">' + task.name + '</div><div class="text-xs text-gray-600 mt-1">' + task.deadline + ' | ' + (task.owner || 'Unassigned') + '</div></div>').join('') + '</div></div>' : '') +
            
            (studyData.closeoutTasks.length > 0 ? '<div class="grid grid-cols-2 gap-6 mb-6"><div class="bg-white rounded-lg shadow border p-5"><h3 class="font-semibold mb-3">üü° Ready (' + readyTasks.length + ')</h3><div class="space-y-2 max-h-64 overflow-y-auto">' + (readyTasks.length === 0 ? '<p class="text-gray-500 text-sm">None</p>' : readyTasks.map(task => '<div class="bg-yellow-50 border border-yellow-200 rounded p-3 cursor-pointer hover:bg-yellow-100 transition-colors" onclick="editTask(' + task.id + ')"><div class="font-medium text-sm">' + task.name + '</div><div class="text-xs text-gray-600 mt-1">' + task.category + ' | ' + task.deadline + '</div></div>').join('')) + '</div></div><div class="bg-white rounded-lg shadow border p-5"><h3 class="font-semibold mb-3">üî¥ Blocked (' + blockedTasks.length + ')</h3><div class="space-y-2 max-h-64 overflow-y-auto">' + (blockedTasks.length === 0 ? '<p class="text-gray-500 text-sm">None</p>' : blockedTasks.map(task => '<div class="bg-red-50 border border-red-200 rounded p-3 cursor-pointer hover:bg-red-100 transition-colors" onclick="editTask(' + task.id + ')"><div class="font-medium text-sm">' + task.name + '</div><div class="text-xs text-gray-600 mt-1">Waiting on ' + task.dependencies.length + ' task(s)</div></div>').join('')) + '</div></div></div>' : '') +
            
            (categoryProgress.some(c => c.total > 0) ? '<div class="bg-white rounded-lg shadow border p-6 mb-6"><h2 class="text-lg font-semibold mb-4">üìä Progress by Category</h2><div class="grid grid-cols-3 gap-4">' + categoryProgress.filter(c => c.total > 0).map(cat => {
                const pending = cat.total - cat.completed;
                return '<div class="border rounded-lg p-4 cursor-pointer hover:bg-blue-50 transition" onclick="showCategoryDetails(\'' + cat.name + '\')"><div class="flex justify-between mb-2"><h3 class="font-medium">' + cat.name + '</h3><span class="text-sm font-semibold">' + cat.percentage + '%</span></div><div class="w-full bg-gray-200 rounded-full h-2 mb-2"><div class="bg-blue-500 h-2 rounded-full" style="width: ' + cat.percentage + '%"></div></div><p class="text-xs text-gray-500">' + cat.completed + ' of ' + cat.total + ' completed</p><p class="text-xs text-orange-600 font-medium mt-1">' + pending + ' pending</p></div>';
            }).join('') + '</div></div>' : '') +
            
            '<div class="bg-white rounded-lg shadow border p-6"><div class="flex justify-between items-center mb-4"><div><h2 class="text-lg font-semibold">üìã Tasks (' + filtered.length + ')</h2>' + (studyData.loadedTemplate ? '<p class="text-sm text-gray-600 mt-1">Template: <span class="font-medium text-blue-600">' + studyData.loadedTemplate + '</span></p>' : '') + '</div><div class="flex gap-2"><button onclick="showModal(\'workflow\')" class="px-3 py-2 text-sm border rounded-md hover:bg-gray-50">üîÄ Workflow</button><button onclick="showModal(\'timeline\')" class="px-3 py-2 text-sm border rounded-md hover:bg-gray-50">üìÖ Timeline</button></div></div><div class="mb-4"><input type="text" id="searchInput" placeholder="üîç Search tasks by name, description, owner, or role..." class="w-full px-4 py-2 border rounded-md text-sm" value="' + searchQuery + '"></div><div class="flex flex-wrap gap-3 mb-4"><div class="flex items-center gap-2"><label class="text-sm font-medium">Sort:</label><select onchange="window.currentSort=this.value; render();" class="px-3 py-2 border rounded-md text-sm">' + ['deadline', 'name', 'priority', 'status'].map(s => '<option value="' + s + '" ' + (sort === s ? 'selected' : '') + '>' + s.charAt(0).toUpperCase() + s.slice(1) + '</option>').join('') + '</select></div><div class="flex items-center gap-2"><label class="text-sm font-medium">Filter:</label><select onchange="window.currentFilter.category=this.value; render();" class="px-3 py-2 border rounded-md text-sm"><option value="">All Categories</option>' + studyData.categories.map(c => '<option ' + (filter.category === c ? 'selected' : '') + '>' + c + '</option>').join('') + '</select><select onchange="window.currentFilter.priority=this.value; render();" class="px-3 py-2 border rounded-md text-sm"><option value="">All Priorities</option>' + ['Critical', 'High', 'Medium', 'Low'].map(p => '<option ' + (filter.priority === p ? 'selected' : '') + '>' + p + '</option>').join('') + '</select><select onchange="window.currentFilter.status=this.value; render();" class="px-3 py-2 border rounded-md text-sm"><option value="">All Status</option><option value="blocked">Blocked</option><option value="ready">Ready</option><option value="inprogress">In Progress</option><option value="completed">Completed</option></select></div></div><div class="overflow-x-auto"><table class="w-full text-sm"><thead class="bg-gray-50 border-b"><tr><th class="text-left p-3">Task</th><th class="text-left p-3">Category</th><th class="text-left p-3">Owner</th><th class="text-left p-3">Priority</th><th class="text-left p-3">Deadline</th><th class="text-left p-3">Status</th><th class="text-left p-3">Smart Status</th><th class="text-left p-3">Progress</th><th class="text-left p-3">Deps</th><th class="text-left p-3">Actions</th></tr></thead><tbody>' + (filtered.length === 0 ? '<tr><td colspan="10" class="p-8 text-center text-gray-500">No tasks. Click "Templates" or "+ Task"</td></tr>' : filtered.map(task => {
                const deps = task.dependencies.map(id => studyData.closeoutTasks.find(t => t.id === id)?.name || 'Unknown').join(', ');
                const smartStatus = getTaskStatus(task);
                return '<tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="editTask(' + task.id + ')"><td class="p-3"><div class="font-medium">' + task.name + '</div><div class="text-xs text-gray-500">' + task.role + '</div>' + (task.description ? '<div class="text-xs text-gray-600 italic">' + task.description + '</div>' : '') + '</td><td class="p-3 text-gray-600">' + task.category + '</td><td class="p-3">' + (task.owner || '<span class="text-gray-400">Unassigned</span>') + '</td><td class="p-3"><span class="px-2 py-1 rounded text-xs border ' + (task.priority === 'Critical' ? 'bg-red-100 text-red-800' : task.priority === 'High' ? 'bg-orange-100 text-orange-800' : task.priority === 'Medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800') + '">' + task.priority + '</span></td><td class="p-3">' + task.deadline + '</td><td class="p-3"><span class="px-2 py-1 rounded text-xs ' + (task.status === 'Completed' ? 'bg-green-100 text-green-800' : task.status === 'In Progress' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800') + '">' + task.status + '</span></td><td class="p-3"><span class="px-2 py-1 rounded text-xs border font-medium ' + getStatusColor(smartStatus) + '">' + getStatusIcon(smartStatus) + ' ' + getStatusLabel(smartStatus) + '</span></td><td class="p-3"><div class="flex items-center gap-2"><div class="w-16 bg-gray-200 rounded-full h-2"><div class="h-2 rounded-full ' + (task.status === 'Completed' ? 'bg-green-500' : task.status === 'In Progress' ? 'bg-blue-500' : 'bg-gray-300') + '" style="width: ' + task.progress + '%"></div></div><span class="text-xs">' + task.progress + '%</span></div></td><td class="p-3"><span class="text-xs text-gray-500" title="' + deps + '">' + (task.dependencies.length > 0 ? task.dependencies.length : 'None') + '</span></td><td class="p-3"><button onclick="event.stopPropagation(); editTask(' + task.id + ')" class="text-green-600 mr-2">‚úèÔ∏è</button><button onclick="event.stopPropagation(); deleteTask(' + task.id + ')" class="text-red-600">üóëÔ∏è</button></td></tr>';
            }).join('')) + '</tbody></table></div></div></div>';
            updateSaveStatus();
            
            // Add search input event listener after DOM is ready
            setTimeout(() => {
                const searchInput = document.getElementById('searchInput');
                if (searchInput && !searchInput.dataset.listenerAttached) {
                    searchInput.dataset.listenerAttached = 'true';
                    searchInput.addEventListener('input', function(e) {
                        const currentValue = e.target.value;
                        const currentScroll = window.pageYOffset;
                        const cursorPosition = e.target.selectionStart;
                        
                        window.searchQuery = currentValue.toLowerCase();
                        render();
                        
                        // Restore state after render
                        requestAnimationFrame(() => {
                            const newSearchInput = document.getElementById('searchInput');
                            if (newSearchInput) {
                                newSearchInput.value = currentValue;
                                newSearchInput.setSelectionRange(cursorPosition, cursorPosition);
                                newSearchInput.focus();
                            }
                            window.scrollTo(0, currentScroll);
                        });
                    });
                }
            }, 0);
        }

        window.currentFilter = { category: '', priority: '', status: '' };
        window.currentSort = 'deadline';
        window.editingTask = null;
        window.editingDocIndex = undefined;
        window.editingTemplateId = null;
        window.editingTemplateTaskIndex = null;
        render();
        setInterval(updateSaveStatus, 10000);
        
        // Periodic backup reminder (every 30 minutes)
        let lastBackupReminder = Date.now();
        setInterval(function() {
            if (studyData.closeoutTasks.length > 0 && Date.now() - lastBackupReminder > 1800000) {
                if (confirm('üíæ BACKUP REMINDER\n\nIt\'s been 30 minutes since your last backup reminder.\n\nClick OK to create a backup now, or Cancel to continue working.')) {
                    showModal('backup');
                }
                lastBackupReminder = Date.now();
            }
        }, 300000); // Check every 5 minutes
        
        // Warn user before closing tab/browser if there's data
        window.addEventListener('beforeunload', function(e) {
            // Only show warning if there are tasks (i.e., user has data)
            if (studyData.closeoutTasks.length > 0) {
                // Modern browsers show their own message and ignore custom text
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
    </script>
</body>
</html>